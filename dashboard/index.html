<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MVP Trading Dashboard (Paper)</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 16px;
      background: #f5f5f5;
    }

    .grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 16px;
    }

    .card {
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, .08);
      background: white;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    th,
    td {
      border-bottom: 1px solid #eee;
      padding: 8px;
      text-align: right;
    }

    th:first-child,
    td:first-child {
      text-align: left;
    }

    th {
      background: #fafafa;
      font-weight: 600;
    }

    .kpis {
      display: flex;
      gap: 12px;
    }

    .kpi {
      flex: 1;
      background: #fafafa;
      padding: 12px;
      border-radius: 8px;
      text-align: center;
    }

    .kpi h3 {
      margin: 8px 0 0 0;
      font-size: 24px;
    }

    .kpi div {
      font-size: 12px;
      color: #666;
      text-transform: uppercase;
    }

    .signal-long {
      color: #0a7f42;
      font-weight: bold;
    }

    .signal-short {
      color: #b00020;
      font-weight: bold;
    }

    .signal-neutral {
      color: #666;
    }

    .muted {
      color: #666;
      font-size: 12px;
      line-height: 1.5;
    }

    .llm-box {
      background: #f0f7ff;
      padding: 12px;
      border-radius: 6px;
      margin-top: 12px;
    }

    h2 {
      margin-top: 0;
    }

    h3 {
      margin-top: 0;
      color: #333;
    }

    .signals-container {
      max-height: 600px;
      overflow-y: auto;
      overflow-x: hidden;
      padding-right: 8px;
    }

    .signals-container::-webkit-scrollbar {
      width: 8px;
    }

    .signals-container::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }

    .signals-container::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }

    .signals-container::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    .signal-item {
      border-bottom: 1px solid #eee;
      padding: 12px 0;
      cursor: pointer;
      transition: background 0.2s;
    }

    .signal-item:hover {
      background: #f8f8f8;
      border-radius: 4px;
      padding-left: 8px;
    }

    .signal-item:last-child {
      border-bottom: none;
    }

    .signal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .signal-type {
      font-weight: bold;
      font-size: 14px;
    }

    .signal-time {
      font-size: 11px;
      color: #999;
    }

    .signal-details {
      font-size: 12px;
      color: #666;
      line-height: 1.6;
    }

    .signal-price {
      font-size: 14px;
      font-weight: 600;
      margin: 4px 0;
    }

    .signal-explanation {
      background: #f0f7ff;
      padding: 8px;
      border-radius: 4px;
      margin-top: 8px;
      font-size: 11px;
      line-height: 1.5;
      display: none;
    }

    .signal-item.expanded .signal-explanation {
      display: block;
    }

    .expand-icon {
      font-size: 10px;
      color: #999;
    }

    .active-signal-box {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 16px;
      border-radius: 10px;
      margin-bottom: 16px;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .active-signal-box h3 {
      margin: 0 0 8px 0;
      color: white;
      font-size: 16px;
    }

    .active-signal-type {
      font-size: 20px;
      font-weight: bold;
      margin: 8px 0;
    }

    .active-signal-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 12px;
      font-size: 13px;
    }

    .detail-item {
      background: rgba(255, 255, 255, 0.15);
      padding: 6px 10px;
      border-radius: 6px;
    }

    .detail-label {
      font-size: 10px;
      opacity: 0.8;
      text-transform: uppercase;
    }

    .detail-value {
      font-weight: bold;
      font-size: 14px;
      margin-top: 2px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 12px;
    }

    .stat-box {
      background: #fafafa;
      padding: 10px;
      border-radius: 6px;
      text-align: center;
      border: 1px solid #eee;
    }

    .stat-label {
      font-size: 11px;
      color: #666;
      text-transform: uppercase;
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: 16px;
      font-weight: bold;
      color: #333;
    }

    .period-info {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 6px;
      font-size: 12px;
      color: #666;
      margin-top: 12px;
      border-left: 3px solid #667eea;
    }

    /* Estilos para selectores */
    select:focus {
      outline: none;
      border-color: #764ba2;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
    }

    select:hover {
      border-color: #764ba2;
    }

    .controls-card {
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ed 100%);
    }

    /* Estilo para el contenedor del gr√°fico */
    #chartContainer {
      background: #fff;
      border-radius: 4px;
    }

    /* ========== ESTILOS PARA AN√ÅLISIS LLM ========== */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    #generateAnalysisBtn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(233, 69, 96, 0.4);
    }

    #generateAnalysisBtn:active {
      transform: translateY(0);
    }

    #generateAnalysisBtn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .accordion-header:hover {
      filter: brightness(1.1);
    }

    #analysisAccordionContent::-webkit-scrollbar {
      width: 8px;
    }

    #analysisAccordionContent::-webkit-scrollbar-track {
      background: rgba(15, 52, 96, 0.3);
      border-radius: 4px;
    }

    #analysisAccordionContent::-webkit-scrollbar-thumb {
      background: #e94560;
      border-radius: 4px;
    }

    #analysisAccordionContent::-webkit-scrollbar-thumb:hover {
      background: #ff6b6b;
    }

    /* Estilos para el texto del an√°lisis */
    #analysisText h1, #analysisText h2, #analysisText h3 {
      color: #e94560;
      margin-top: 16px;
      margin-bottom: 8px;
    }

    #analysisText strong {
      color: #4fc3f7;
    }

    #analysisText em {
      color: #81c784;
    }

    #analysisText code {
      background: rgba(233, 69, 96, 0.2);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Consolas', monospace;
    }
    /* ========== FIN ESTILOS AN√ÅLISIS LLM ========== */

    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <h2>üìä MVP Trading ‚Äî Paper Trading Dashboard <small style="color: #999; font-size: 14px;">(v4.1 - CON AN√ÅLISIS LLM)</small>
    <span id="refresh-indicator" style="float: right; font-size: 13px; font-weight: normal; color: #667eea; background: #e8f0fe; padding: 4px 12px; border-radius: 20px;">üîÑ Auto-refresh en 60s</span>
  </h2>
  <p class="muted">Esto es √∫nicamente con fines educativos y no constituye asesor√≠a financiera.</p>

  <!-- Panel de Controles -->
  <div class="card" style="margin-bottom: 16px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);">
    <div style="display: flex; flex-wrap: wrap; gap: 16px; align-items: flex-end;">
      <!-- Selector de Ticker -->
      <div style="flex: 1; min-width: 180px;">
        <label style="display: block; font-size: 12px; font-weight: 600; color: #333; margin-bottom: 6px;">
          üìà Ticker / S√≠mbolo
        </label>
        <select id="tickerSelect" style="width: 100%; padding: 10px 12px; border: 2px solid #667eea; border-radius: 8px; font-size: 14px; background: white; cursor: pointer;">
          <option value="AAPL">AAPL - Apple Inc.</option>
          <option value="MSFT">MSFT - Microsoft</option>
          <option value="GOOGL">GOOGL - Alphabet</option>
          <option value="AMZN">AMZN - Amazon</option>
          <option value="TSLA">TSLA - Tesla</option>
          <option value="META">META - Meta Platforms</option>
          <option value="NVDA">NVDA - NVIDIA</option>
          <option value="JPM">JPM - JPMorgan Chase</option>
          <option value="V">V - Visa Inc.</option>
          <option value="JNJ">JNJ - Johnson & Johnson</option>
          <option value="EURUSD=X">EUR/USD - Euro/D√≥lar</option>
          <option value="GBPUSD=X">GBP/USD - Libra/D√≥lar</option>
          <option value="USDJPY=X">USD/JPY - D√≥lar/Yen</option>
          <option value="BTC-USD">BTC/USD - Bitcoin</option>
          <option value="ETH-USD">ETH/USD - Ethereum</option>
          <option value="SPY">SPY - S&P 500 ETF</option>
          <option value="QQQ">QQQ - NASDAQ 100 ETF</option>
        </select>
      </div>

      <!-- Selector de Rango de Tiempo -->
      <div style="flex: 1; min-width: 150px;">
        <label style="display: block; font-size: 12px; font-weight: 600; color: #333; margin-bottom: 6px;">
          üìÖ Rango Hist√≥rico
        </label>
        <select id="rangeSelect" style="width: 100%; padding: 10px 12px; border: 2px solid #667eea; border-radius: 8px; font-size: 14px; background: white; cursor: pointer;">
          <option value="0.02">1 Semana</option>
          <option value="0.08" selected>1 Mes</option>
          <option value="0.25">3 Meses</option>
          <option value="0.5">6 Meses</option>
          <option value="1">1 A√±o</option>
          <option value="2">2 A√±os</option>
          <option value="5">5 A√±os</option>
          <option value="10">10 A√±os</option>
        </select>
      </div>

      <!-- Selector de Intervalo de Velas -->
      <div style="flex: 1; min-width: 150px;">
        <label style="display: block; font-size: 12px; font-weight: 600; color: #333; margin-bottom: 6px;">
          üïê Intervalo de Velas
        </label>
        <select id="intervalSelect" style="width: 100%; padding: 10px 12px; border: 2px solid #667eea; border-radius: 8px; font-size: 14px; background: white; cursor: pointer;">
          <option value="1m">1 Minuto</option>
          <option value="5m" selected>5 Minutos</option>
          <option value="15m">15 Minutos</option>
          <option value="1h">1 Hora</option>
          <option value="1d">1 D√≠a</option>
          <option value="1mo">1 Mes</option>
        </select>
      </div>

      <!-- Bot√≥n de Actualizar -->
      <div style="min-width: 150px;">
        <button id="loadDataBtn" style="width: 100%; padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); transition: transform 0.2s, box-shadow 0.2s;">
          üîÑ Cargar Datos
        </button>
      </div>
    </div>
    <p style="margin: 10px 0 0 0; font-size: 11px; color: #666;">
      ‚ö†Ô∏è <strong>Nota:</strong> Intervalos de 1m y 5m est√°n limitados a datos recientes (m√°x 7-60 d√≠as). Para mayor hist√≥rico, usa intervalos de 1h, 1d o 1mo.
    </p>
  </div>

  <div class="grid">
    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
        <h3 style="margin: 0;">Gr√°fico de Precios con Se√±ales - <span id="currentTicker">AAPL</span></h3>
        <button id="resetZoom"
          style="padding: 6px 12px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
          üîç Resetear Zoom
        </button>
      </div>
      <div id="loadingOverlay" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255,255,255,0.9); padding: 20px 40px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); z-index: 100;">
        <div style="text-align: center;">
          <div style="font-size: 24px; margin-bottom: 10px;">‚è≥</div>
          <div style="font-weight: 600;">Cargando datos...</div>
        </div>
      </div>
      <!-- Contenedor del gr√°fico -->
      <div id="chartContainer" style="width: 100%; height: 380px; position: relative;">
        <canvas id="priceChart"></canvas>
      </div>
      <p id="chartNavHelp" class="muted" style="margin-top: 8px; font-size: 11px;">
        üí° <strong>Controles:</strong> Rueda del mouse para zoom | Arrastrar para pan | "Resetear Zoom" para vista original
      </p>
      
      <!-- Contenedor de Detalle de Votaci√≥n de Estrategias -->
      <div id="votingDetailContainer" style="display: none; margin-top: 16px; background: linear-gradient(135deg, #f8f9ff 0%, #e8f4ff 100%); border-radius: 12px; padding: 16px; border: 2px solid #667eea; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.15);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <h4 style="margin: 0; color: #333; font-size: 15px;">
            üó≥Ô∏è <span id="votingTitle">Detalle de Votaci√≥n - Sistema de Estrategias</span>
          </h4>
          <button id="closeVotingDetail" onclick="document.getElementById('votingDetailContainer').style.display='none';" 
                  style="background: #ff5252; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px; line-height: 1;">‚úï</button>
        </div>
        
        <!-- Resumen de votaci√≥n -->
        <div id="votingSummary" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 14px;">
          <div style="background: white; padding: 10px; border-radius: 8px; text-align: center; border: 1px solid #ddd;">
            <div style="font-size: 11px; color: #666; text-transform: uppercase;">Se√±al Final</div>
            <div id="votingFinalSignal" style="font-size: 18px; font-weight: bold; margin-top: 4px;">‚Äî</div>
          </div>
          <div style="background: #e8f5e9; padding: 10px; border-radius: 8px; text-align: center; border: 1px solid #a5d6a7;">
            <div style="font-size: 11px; color: #2e7d32; text-transform: uppercase;">Votos LONG</div>
            <div id="votingLongCount" style="font-size: 18px; font-weight: bold; color: #2e7d32; margin-top: 4px;">0</div>
          </div>
          <div style="background: #ffebee; padding: 10px; border-radius: 8px; text-align: center; border: 1px solid #ef9a9a;">
            <div style="font-size: 11px; color: #c62828; text-transform: uppercase;">Votos SHORT</div>
            <div id="votingShortCount" style="font-size: 18px; font-weight: bold; color: #c62828; margin-top: 4px;">0</div>
          </div>
          <div style="background: #f5f5f5; padding: 10px; border-radius: 8px; text-align: center; border: 1px solid #e0e0e0;">
            <div style="font-size: 11px; color: #666; text-transform: uppercase;">Neutral</div>
            <div id="votingNeutralCount" style="font-size: 18px; font-weight: bold; color: #757575; margin-top: 4px;">0</div>
          </div>
        </div>
        
        <!-- Detalle por estrategia -->
        <div id="strategyVotesGrid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
          <!-- Se llenar√° din√°micamente -->
        </div>
        
        <!-- Informaci√≥n adicional -->
        <div id="votingInfo" style="margin-top: 14px; padding: 10px; background: rgba(102, 126, 234, 0.1); border-radius: 8px; font-size: 12px; color: #555;">
          <strong>üìä Metodolog√≠a:</strong> La se√±al final se determina por <em>votaci√≥n mayoritaria</em>. Se requiere que al menos la mitad +1 de las estrategias coincidan para generar una se√±al. En caso de empate, se usa el <em>score promedio</em> como desempate.
        </div>
      </div>
      
      <!-- ========== CONTENEDOR DE AN√ÅLISIS LLM ========== -->
      <div id="llmAnalysisContainer" style="margin-top: 16px; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border-radius: 12px; padding: 16px; border: 2px solid #0f3460; box-shadow: 0 4px 20px rgba(15, 52, 96, 0.3);">
        
        <!-- Header con bot√≥n -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <h4 style="margin: 0; color: #e94560; font-size: 16px; display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 20px;">ü§ñ</span> An√°lisis Inteligente con IA
          </h4>
          <button id="generateAnalysisBtn" onclick="generateLLMAnalysis()" 
                  style="background: linear-gradient(135deg, #e94560 0%, #0f3460 100%); color: white; border: none; border-radius: 8px; padding: 10px 20px; cursor: pointer; font-weight: bold; font-size: 13px; display: flex; align-items: center; gap: 8px; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(233, 69, 96, 0.3);">
            <span id="analysisButtonIcon">‚ú®</span>
            <span id="analysisButtonText">Generar An√°lisis</span>
          </button>
        </div>
        
        <!-- Info del an√°lisis -->
        <div style="background: rgba(233, 69, 96, 0.1); border-radius: 8px; padding: 10px; margin-bottom: 12px; border-left: 3px solid #e94560;">
          <p style="margin: 0; font-size: 12px; color: #a0a0a0; line-height: 1.5;">
            <strong style="color: #e94560;">¬øQu√© hace?</strong> Analiza todas las se√±ales del per√≠odo usando <strong>Google Gemini</strong> para explicar cada decisi√≥n de trading, las estrategias evaluadas y la gesti√≥n de riesgo.
          </p>
        </div>
        
        <!-- Indicador de carga -->
        <div id="analysisLoadingIndicator" style="display: none; text-align: center; padding: 40px 20px;">
          <div style="display: inline-block; position: relative; width: 80px; height: 80px;">
            <div style="position: absolute; width: 60px; height: 60px; border: 4px solid transparent; border-top-color: #e94560; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <div style="position: absolute; width: 45px; height: 45px; top: 7.5px; left: 7.5px; border: 4px solid transparent; border-top-color: #0f3460; border-radius: 50%; animation: spin 1.5s linear infinite reverse;"></div>
            <div style="position: absolute; width: 30px; height: 30px; top: 15px; left: 15px; border: 4px solid transparent; border-top-color: #533483; border-radius: 50%; animation: spin 2s linear infinite;"></div>
          </div>
          <p style="margin-top: 16px; color: #e94560; font-weight: bold; font-size: 14px;">üß† Analizando se√±ales con IA...</p>
          <p style="margin: 8px 0 0 0; color: #a0a0a0; font-size: 12px;">Esto puede tomar unos segundos</p>
        </div>
        
        <!-- Contenido del an√°lisis (acorde√≥n) -->
        <div id="analysisContent" style="display: none;">
          <!-- Resumen r√°pido -->
          <div id="analysisSummary" style="background: rgba(15, 52, 96, 0.5); border-radius: 8px; padding: 12px; margin-bottom: 12px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
            <div style="text-align: center;">
              <div style="font-size: 11px; color: #a0a0a0; text-transform: uppercase;">Se√±ales Analizadas</div>
              <div id="analysisSignalCount" style="font-size: 24px; font-weight: bold; color: #e94560;">0</div>
            </div>
            <div style="text-align: center;">
              <div style="font-size: 11px; color: #a0a0a0; text-transform: uppercase;">Fuente</div>
              <div id="analysisSource" style="font-size: 14px; font-weight: bold; color: #0f3460; margin-top: 4px;">
                <span style="background: linear-gradient(135deg, #4285f4, #34a853); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Google Gemini</span>
              </div>
            </div>
            <div style="text-align: center;">
              <div style="font-size: 11px; color: #a0a0a0; text-transform: uppercase;">Cach√©</div>
              <div id="analysisCacheStatus" style="font-size: 14px; font-weight: bold; margin-top: 4px;">‚Äî</div>
            </div>
          </div>
          
          <!-- Acorde√≥n con el an√°lisis completo -->
          <div id="analysisAccordion" style="border-radius: 8px; overflow: hidden;">
            <div class="accordion-header" onclick="toggleAnalysisAccordion()" style="background: linear-gradient(135deg, #0f3460 0%, #533483 100%); padding: 14px 16px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s ease;">
              <span style="color: white; font-weight: bold; font-size: 14px;">üìã Ver An√°lisis Detallado</span>
              <span id="accordionIcon" style="color: white; font-size: 18px; transition: transform 0.3s ease;">‚ñº</span>
            </div>
            <div id="analysisAccordionContent" style="display: none; background: rgba(26, 26, 46, 0.8); padding: 16px; max-height: 500px; overflow-y: auto;">
              <div id="analysisText" style="color: #e0e0e0; font-size: 13px; line-height: 1.8; white-space: pre-wrap; font-family: 'Segoe UI', system-ui, sans-serif;"></div>
            </div>
          </div>
          
          <!-- Error si existe -->
          <div id="analysisError" style="display: none; background: rgba(244, 67, 54, 0.1); border: 1px solid #f44336; border-radius: 8px; padding: 12px; margin-top: 12px;">
            <p style="margin: 0; color: #f44336; font-size: 12px;">
              <strong>‚ö†Ô∏è Aviso:</strong> <span id="analysisErrorText"></span>
            </p>
          </div>
        </div>
        
        <!-- Estado vac√≠o inicial -->
        <div id="analysisEmpty" style="text-align: center; padding: 20px; color: #a0a0a0;">
          <p style="margin: 0; font-size: 13px;">Presiona <strong style="color: #e94560;">"Generar An√°lisis"</strong> para obtener una explicaci√≥n detallada de las se√±ales.</p>
        </div>
      </div>
      <!-- ========== FIN CONTENEDOR DE AN√ÅLISIS LLM ========== -->
      
    </div>
    <div class="card">
      <h3>üìä Estado del Trading</h3>
      
      <!-- Se√±al Activa -->
      <div id="activeSignalBox" class="active-signal-box" style="display: none;">
        <h3>üéØ SE√ëAL ACTIVA</h3>
        <div class="active-signal-type" id="activeSignalType">‚Äî</div>
        <div class="active-signal-details">
          <div class="detail-item">
            <div class="detail-label">Precio</div>
            <div class="detail-value" id="activePrice">‚Äî</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Stop Loss</div>
            <div class="detail-value" id="activeSL">‚Äî</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Take Profit</div>
            <div class="detail-value" id="activeTP">‚Äî</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">R/R Ratio</div>
            <div class="detail-value" id="activeRR">‚Äî</div>
          </div>
        </div>
      </div>

      <!-- Estad√≠sticas de Se√±ales -->
      <h3 style="margin-bottom: 8px; margin-top: 16px;">üìà Estad√≠sticas (<span id="signalsCount">0</span> se√±ales)</h3>
      <div class="stats-grid">
        <div class="stat-box">
          <div class="stat-label">LONG (Compra)</div>
          <div class="stat-value" style="color: #0a7f42;" id="longCount">‚Äî</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">SHORT (Venta)</div>
          <div class="stat-value" style="color: #b00020;" id="shortCount">‚Äî</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Precio M√≠n</div>
          <div class="stat-value" id="minPrice">‚Äî</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Precio M√°x</div>
          <div class="stat-value" id="maxPrice">‚Äî</div>
        </div>
      </div>
      
      <div class="period-info" id="periodInfo">
        <strong>üìÖ Periodo:</strong> <span id="dateRange">‚Äî</span>
      </div>
      
      <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 16px;">
        <h3 style="margin-bottom: 12px;">üìã Historial de Se√±ales</h3>
        <div id="signalsContainer" class="signals-container">
          <p class="muted" style="text-align: center; padding: 20px 0;">Cargando se√±ales...</p>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.2.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
  <script>
    const API_BASE = "http://127.0.0.1:8000";
    let currentChart = null;  // Para destruir el chart anterior

    async function fetchJSON(url, fallback) {
      try {
        const r = await fetch(url);
        if (!r.ok) throw new Error("HTTP " + r.status);
        return await r.json();
      } catch (e) {
        console.warn("Error fetching", url, e);
        return fallback;
      }
    }

    async function loadMetrics() {
      try {
        const response = await fetch('/backtest_report.json');
        if (response.ok) {
          const data = await response.json();
          return data;
        }
      } catch (e) {
        console.warn("No backtest report found");
      }
      return { metrics: { CAGR: 0.04, Sharpe: 0.16, MaxDrawdown: -0.034 }, last_equity: 10000 };
    }

    function getSignalLabel(signal) {
      if (signal === 1) return '<span class="signal-long">LONG ‚ñ≤</span>';
      if (signal === -1) return '<span class="signal-short">SHORT ‚ñº</span>';
      return '<span class="signal-neutral">‚Äî</span>';
    }

    function getSelectedParams() {
      return {
        ticker: document.getElementById('tickerSelect').value,
        years: parseFloat(document.getElementById('rangeSelect').value),
        interval: document.getElementById('intervalSelect').value
      };
    }

    // Funci√≥n para obtener el formato de fecha apropiado seg√∫n el rango e intervalo
    function getDateFormat(years, interval) {
      // Para intervalos mensuales
      if (interval === '1mo') {
        if (years >= 5) {
          return { format: { year: 'numeric' }, skipFactor: 12 };  // Solo a√±o
        } else if (years >= 2) {
          return { format: { year: 'numeric', month: 'short' }, skipFactor: 6 };  // A√±o + mes
        } else {
          return { format: { year: '2-digit', month: 'short' }, skipFactor: 3 };  // Cada 3 meses
        }
      }
      
      // Para intervalos diarios
      if (interval === '1d') {
        if (years >= 5) {
          return { format: { year: 'numeric' }, skipFactor: 365 };  // Solo a√±o
        } else if (years >= 2) {
          return { format: { day: '2-digit', month: 'short', year: '2-digit' }, skipFactor: 90 };  // D√≠a + mes + a√±o cada 3 meses
        } else if (years >= 1) {
          return { format: { day: '2-digit', month: 'short', year: '2-digit' }, skipFactor: 30 };  // Cada mes con a√±o
        } else if (years >= 0.5) {
          return { format: { day: '2-digit', month: 'short' }, skipFactor: 14 };  // Cada 2 semanas
        } else {
          return { format: { day: '2-digit', month: 'short' }, skipFactor: 7 };  // Cada semana
        }
      }
      
      // Para intervalos de hora
      if (interval === '1h') {
        if (years >= 1) {
          return { format: { day: '2-digit', month: 'short', year: '2-digit' }, skipFactor: 168 };  // Cada semana con a√±o
        } else if (years >= 0.25) {
          return { format: { day: '2-digit', month: 'short' }, skipFactor: 24 };  // Cada d√≠a
        } else {
          return { format: { day: '2-digit', hour: '2-digit', minute: '2-digit' }, skipFactor: 12 };  // Cada 12h
        }
      }
      
      // Para intervalos de 15 minutos
      if (interval === '15m') {
        if (years >= 0.08) {
          return { format: { month: 'short', day: '2-digit' }, skipFactor: 96 };  // Cada d√≠a
        } else {
          return { format: { day: '2-digit', hour: '2-digit', minute: '2-digit' }, skipFactor: 16 };  // Cada 4h
        }
      }
      
      // Para intervalos de 5 minutos o 1 minuto
      if (interval === '5m' || interval === '1m') {
        if (years >= 0.02) {
          return { format: { day: '2-digit', hour: '2-digit', minute: '2-digit' }, skipFactor: interval === '1m' ? 60 : 24 };  // Cada hora o 2h
        } else {
          return { format: { hour: '2-digit', minute: '2-digit' }, skipFactor: interval === '1m' ? 30 : 12 };  // Cada 30m o 1h
        }
      }
      
      // Default
      return { format: { month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit' }, skipFactor: 10 };
    }

    function showLoading(show) {
      const overlay = document.getElementById('loadingOverlay');
      const chartCard = document.querySelector('.card');
      if (overlay) {
        overlay.style.display = show ? 'block' : 'none';
      }
      if (chartCard) {
        chartCard.style.position = show ? 'relative' : '';
      }
    }

    async function init() {
      console.log("üîÑ Iniciando carga del dashboard...");
      
      const params = getSelectedParams();
      console.log("üìä Par√°metros:", params);
      
      // Actualizar t√≠tulo con ticker actual
      document.getElementById('currentTicker').innerText = params.ticker;
      
      showLoading(true);
      
      // Construir URL con par√°metros
      const url = `${API_BASE}/signals?ticker=${encodeURIComponent(params.ticker)}&years=${params.years}&interval=${params.interval}`;
      console.log("üåê Consultando:", url);
      
      // Cargar datos
      const signals = await fetchJSON(url, []);
      console.log("üìä Se√±ales cargadas:", signals.length);
      
      showLoading(false);
      
      if (signals.length === 0) {
        console.error("‚ùå No se recibieron se√±ales de la API");
        document.getElementById("signalsContainer").innerHTML = `
          <div style="text-align: center; padding: 30px;">
            <div style="font-size: 48px; margin-bottom: 10px;">üì≠</div>
            <p class="muted">No hay datos disponibles para <strong>${params.ticker}</strong></p>
            <p class="muted" style="font-size: 11px;">Prueba con un rango de tiempo mayor o un intervalo diferente</p>
          </div>
        `;
        return;
      }
      
      console.log("üìà Primera se√±al:", signals[0]);
      console.log("üìâ √öltima se√±al:", signals[signals.length - 1]);
      
      const metrics = await loadMetrics();

      // Cargar explicaciones
      const explanations = await fetchJSON(`${API_BASE}/explanations`, { text: "An√°lisis de trading en progreso..." });

      // Calcular estad√≠sticas de se√±ales
      const signalsWithAction = signals.filter(s => s.signal !== 0);
      const longSignalsData = signalsWithAction.filter(s => s.signal === 1);
      const shortSignalsData = signalsWithAction.filter(s => s.signal === -1);
      
      // Actualizar estad√≠sticas
      document.getElementById("signalsCount").innerText = signalsWithAction.length;
      document.getElementById("longCount").innerText = `${longSignalsData.length} (${((longSignalsData.length / signalsWithAction.length) * 100).toFixed(0)}%)`;
      document.getElementById("shortCount").innerText = `${shortSignalsData.length} (${((shortSignalsData.length / signalsWithAction.length) * 100).toFixed(0)}%)`;
      
      // Calcular rango de precios
      if (signalsWithAction.length > 0) {
        const prices = signalsWithAction.map(s => s.price);
        const minPrice = Math.min(...prices);
        const maxPrice = Math.max(...prices);
        document.getElementById("minPrice").innerText = `$${minPrice.toFixed(2)}`;
        document.getElementById("maxPrice").innerText = `$${maxPrice.toFixed(2)}`;
        
        // Calcular rango de fechas con a√±o incluido
        const firstSignal = new Date(signalsWithAction[0].timestamp);
        const lastSignal = new Date(signalsWithAction[signalsWithAction.length - 1].timestamp);
        
        // Formato de fecha para el periodo seg√∫n el intervalo
        let periodDateFormat;
        if (params.interval === '1mo') {
          periodDateFormat = { month: 'short', year: 'numeric' };
        } else if (params.interval === '1d' && params.years >= 1) {
          periodDateFormat = { day: '2-digit', month: 'short', year: '2-digit' };
        } else {
          periodDateFormat = { day: '2-digit', month: 'short', year: '2-digit' };
        }
        
        document.getElementById("dateRange").innerText = `${firstSignal.toLocaleDateString('es-ES', periodDateFormat)} - ${lastSignal.toLocaleDateString('es-ES', periodDateFormat)}`;
        
        // Mostrar se√±al activa (la m√°s reciente)
        const lastActiveSignal = signalsWithAction[signalsWithAction.length - 1];
        const activeBox = document.getElementById("activeSignalBox");
        activeBox.style.display = "block";
        
        const signalType = lastActiveSignal.signal === 1 ? "üü¢ LONG (Compra)" : "üî¥ SHORT (Venta)";
        
        // Fecha completa para la se√±al activa
        const activeSignalDate = new Date(lastActiveSignal.timestamp);
        let activeSignalFormat;
        if (params.interval === '1mo') {
          activeSignalFormat = { month: 'long', year: 'numeric' };
        } else if (params.interval === '1d') {
          activeSignalFormat = { weekday: 'short', day: '2-digit', month: 'short', year: 'numeric' };
        } else {
          activeSignalFormat = { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' };
        }
        const signalTime = activeSignalDate.toLocaleString('es-ES', activeSignalFormat);
        
        document.getElementById("activeSignalType").innerText = `${signalType} - ${signalTime}`;
        document.getElementById("activePrice").innerText = `$${lastActiveSignal.price.toFixed(2)}`;
        document.getElementById("activeSL").innerText = lastActiveSignal.sl ? `$${lastActiveSignal.sl.toFixed(2)}` : "N/A";
        document.getElementById("activeTP").innerText = lastActiveSignal.tp ? `$${lastActiveSignal.tp.toFixed(2)}` : "N/A";
        
        // Calcular Risk/Reward
        if (lastActiveSignal.sl && lastActiveSignal.tp) {
          const risk = Math.abs(lastActiveSignal.price - lastActiveSignal.sl);
          const reward = Math.abs(lastActiveSignal.tp - lastActiveSignal.price);
          const rr = reward / risk;
          document.getElementById("activeRR").innerText = `1:${rr.toFixed(2)}`;
        } else {
          document.getElementById("activeRR").innerText = "N/A";
        }
      }

      // Renderizar se√±ales en panel lateral (orden inverso: m√°s recientes primero)
      console.log("üéØ Se√±ales activas recibidas:", signalsWithAction.length);
      console.log("üìä Total de barras recibidas:", signals.length);
      
      const container = document.getElementById("signalsContainer");
      container.innerHTML = "";
      
      if (signalsWithAction.length === 0) {
        container.innerHTML = '<p class="muted" style="text-align: center; padding: 20px 0;">No hay se√±ales activas</p>';
      } else {
        // Determinar formato de fecha seg√∫n el intervalo seleccionado
        const getSignalDateFormat = (interval, years) => {
          if (interval === '1m' || interval === '5m' || interval === '15m') {
            return { weekday: 'short', day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' };
          } else if (interval === '1h') {
            return { weekday: 'short', day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' };
          } else if (interval === '1d') {
            if (years >= 2) {
              return { weekday: 'short', day: '2-digit', month: 'short', year: 'numeric' };
            }
            return { weekday: 'short', day: '2-digit', month: 'short', year: 'numeric' };
          } else if (interval === '1mo') {
            return { month: 'long', year: 'numeric' };
          }
          return { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' };
        };
        
        const signalDateFormat = getSignalDateFormat(params.interval, params.years);
        
        // Mostrar se√±ales en orden inverso (m√°s recientes primero)
        signalsWithAction.slice().reverse().forEach((s, index) => {
          const signalType = s.signal === 1 ? "LONG" : "SHORT";
          const signalClass = s.signal === 1 ? "signal-long" : "signal-short";
          const signalIcon = s.signal === 1 ? "‚ñ≤" : "‚ñº";
          const signalAction = s.signal === 1 ? "Compra" : "Venta";
          
          // Fecha completa de la se√±al
          const signalDate = new Date(s.timestamp);
          const fullDate = signalDate.toLocaleString('es-ES', signalDateFormat);
          
          // Fecha corta para el header
          const shortDate = signalDate.toLocaleString('es-ES', {
            day: '2-digit', month: 'short', year: '2-digit', hour: '2-digit', minute: '2-digit'
          });
          
          // Verificar si tiene datos de votaci√≥n
          const hasVotingData = s.strategy_votes && s.strategy_votes.length > 0;
          
          const signalItem = document.createElement("div");
          signalItem.className = "signal-item";
          signalItem.dataset.index = index;
          signalItem.dataset.timestamp = s.timestamp;
          signalItem.style.cursor = hasVotingData ? "pointer" : "default";
          
          // Guardar datos de votaci√≥n en el elemento
          if (hasVotingData) {
            signalItem.dataset.strategyVotes = JSON.stringify(s.strategy_votes);
            signalItem.dataset.longVotes = s.long_votes || 0;
            signalItem.dataset.shortVotes = s.short_votes || 0;
            signalItem.dataset.neutralVotes = s.neutral_votes || 0;
            signalItem.dataset.finalSignal = s.signal;
            signalItem.dataset.price = s.price;
            signalItem.dataset.score = s.score;
          }
          
          const votingBadge = hasVotingData 
            ? `<span style="background: #667eea; color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; margin-left: 8px;">üó≥Ô∏è ${s.long_votes || 0}L / ${s.short_votes || 0}S</span>`
            : '';
          
          signalItem.innerHTML = `
            <div class="signal-header">
              <span class="signal-type ${signalClass}">${signalIcon} ${signalType} (${signalAction}) ${votingBadge}</span>
              <span class="signal-time">${shortDate}</span>
            </div>
            <div class="signal-date" style="font-size: 11px; color: #667eea; margin-bottom: 4px; font-weight: 500;">
              üìÖ ${fullDate}
            </div>
            <div class="signal-price">Precio: $${s.price.toFixed(2)}</div>
            <div class="signal-details">
              <strong>Confianza:</strong> ${(s.score * 100).toFixed(0)}% | 
              <strong>SL:</strong> $${s.sl ? s.sl.toFixed(2) : "N/A"} | 
              <strong>TP:</strong> $${s.tp ? s.tp.toFixed(2) : "N/A"}
            </div>
            ${hasVotingData ? '<div style="text-align: center; margin-top: 6px; font-size: 11px; color: #667eea;">üëÜ Clic para ver detalle de votaci√≥n</div>' : ''}
            <div class="signal-explanation">
              <strong>ü§ñ Explicaci√≥n IA:</strong><br>
              ${explanations.text || "An√°lisis t√©cnico basado en cruces de EMAs y confirmaci√≥n de indicadores."}
            </div>
            <div style="text-align: right; margin-top: 4px;">
              <span class="expand-icon">‚ñº Ver m√°s</span>
            </div>
          `;
          
          // Evento de clic para mostrar detalle de votaci√≥n
          signalItem.addEventListener("click", function(e) {
            if (hasVotingData) {
              showVotingDetail(this);
            }
            // Toggle explicaci√≥n
            this.classList.toggle("expanded");
            const icon = this.querySelector(".expand-icon");
            icon.textContent = this.classList.contains("expanded") ? "‚ñ≤ Ver menos" : "‚ñº Ver m√°s";
          });
          
          container.appendChild(signalItem);
        });
      }

      // Preparar datos para gr√°fico de velas
      console.log("üé® Preparando gr√°fico...");
      const ctx = document.getElementById("priceChart").getContext("2d");
      
      // Destruir chart anterior si existe
      if (currentChart) {
        currentChart.destroy();
        currentChart = null;
      }
      
      // Limitar datos para mejor visualizaci√≥n (m√°x 500 barras)
      const maxBars = 500;
      const chartData = signals.length > maxBars ? signals.slice(-maxBars) : signals;
      console.log("üìä Barras para gr√°fico:", chartData.length);

      // Crear datos de velas usando √çNDICES para evitar gaps en el eje X
      const candlestickData = chartData.map((s, i) => ({
        x: i,  // Usar √≠ndice en lugar de timestamp
        o: s.open,
        h: s.high,
        l: s.low,
        c: s.close,
        timestamp: s.timestamp  // Guardar timestamp para tooltips
      }));

      // Detectar se√±ales para marcar en el gr√°fico
      const longSignals = chartData.map((s, i) => ({
        x: i,  // Usar √≠ndice
        y: s.signal === 1 ? s.price : null,
        timestamp: s.timestamp
      })).filter(p => p.y !== null);

      const shortSignals = chartData.map((s, i) => ({
        x: i,  // Usar √≠ndice
        y: s.signal === -1 ? s.price : null,
        timestamp: s.timestamp
      })).filter(p => p.y !== null);

      console.log("‚úÖ Datos preparados - Velas:", candlestickData.length, "| LONG:", longSignals.length, "| SHORT:", shortSignals.length);

      // Obtener formato de fecha din√°mico seg√∫n rango e intervalo
      const dateFormatConfig = getDateFormat(params.years, params.interval);
      console.log("üìÖ Formato de fecha:", dateFormatConfig);

      currentChart = new Chart(ctx, {
        type: "candlestick",
        data: {
          datasets: [
            {
              label: signals.length > 0 ? "Precio" : "EUR/USD",  // Etiqueta gen√©rica
              data: candlestickData,
              color: {
                up: '#26a69a',
                down: '#ef5350',
                unchanged: '#999'
              },
              borderColor: {
                up: '#26a69a',
                down: '#ef5350',
                unchanged: '#999'
              }
            },
            {
              type: 'scatter',
              label: "LONG ‚ñ≤",
              data: longSignals,
              borderColor: "#4CAF50",
              backgroundColor: "#4CAF50",
              pointRadius: 8,
              pointStyle: 'triangle',
              pointRotation: 0
            },
            {
              type: 'scatter',
              label: "SHORT ‚ñº",
              data: shortSignals,
              borderColor: "#F44336",
              backgroundColor: "#F44336",
              pointRadius: 8,
              pointStyle: 'triangle',
              pointRotation: 180
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,  // Permitir que el gr√°fico llene el contenedor
          plugins: {
            legend: {
              display: true,
              position: 'top'
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              backgroundColor: 'rgba(0, 0, 0, 0.85)',
              titleColor: '#fff',
              bodyColor: '#fff',
              borderColor: '#667eea',
              borderWidth: 1,
              padding: 12,
              displayColors: true,
              callbacks: {
                title: function(context) {
                  // Mostrar fecha completa en el tooltip
                  const index = context[0].parsed.x;
                  if (chartData[index]) {
                    const date = new Date(chartData[index].timestamp);
                    return date.toLocaleString('es-ES', {
                      weekday: 'short',
                      day: '2-digit',
                      month: 'short',
                      year: 'numeric',
                      hour: '2-digit',
                      minute: '2-digit'
                    });
                  }
                  return '';
                },
                label: function (context) {
                  const datasetLabel = context.dataset.label || '';
                  const index = context.parsed.x;
                  
                  // Para el dataset de velas (candlestick), mostrar OHLC
                  if (datasetLabel === 'Precio' && chartData[index]) {
                    const candle = chartData[index];
                    return [
                      `Apertura: $${candle.open.toFixed(2)}`,
                      `M√°ximo: $${candle.high.toFixed(2)}`,
                      `M√≠nimo: $${candle.low.toFixed(2)}`,
                      `Cierre: $${candle.close.toFixed(2)}`
                    ];
                  }
                  
                  // Para se√±ales LONG/SHORT
                  if (context.parsed.y !== undefined && context.parsed.y !== null) {
                    return `${datasetLabel}: $${context.parsed.y.toFixed(2)}`;
                  }
                  return null;
                },
                labelColor: function(context) {
                  if (context.dataset.label === 'LONG ‚ñ≤') {
                    return { borderColor: '#4CAF50', backgroundColor: '#4CAF50' };
                  } else if (context.dataset.label === 'SHORT ‚ñº') {
                    return { borderColor: '#F44336', backgroundColor: '#F44336' };
                  }
                  return { borderColor: '#667eea', backgroundColor: '#667eea' };
                }
              }
            },
            zoom: {
              zoom: {
                wheel: {
                  enabled: true,
                  speed: 0.1,
                  modifierKey: null  // Permitir zoom sin tecla modificadora
                },
                pinch: {
                  enabled: true
                },
                drag: {
                  enabled: true,
                  backgroundColor: 'rgba(33, 150, 243, 0.1)',
                  borderColor: 'rgba(33, 150, 243, 0.5)',
                  borderWidth: 1
                },
                mode: 'xy'
              },
              pan: {
                enabled: true,
                mode: 'xy',
                modifierKey: null  // Permitir pan sin necesidad de Ctrl
              },
              limits: {
                x: { min: 'original', max: 'original' },
                y: { min: 'original', max: 'original' }
              }
            }
          },
          scales: {
            x: {
              type: 'linear',
              min: 0,  // Empezar desde el inicio de los datos
              max: chartData.length - 1,  // Terminar en el √∫ltimo dato
              ticks: {
                maxRotation: 45,
                minRotation: 0,
                autoSkip: true,
                autoSkipPadding: 15,
                maxTicksLimit: 12,
                callback: function(value, index) {
                  // Solo mostrar etiquetas para valores enteros v√°lidos
                  if (!Number.isInteger(value) || value < 0 || value >= chartData.length) return '';
                  
                  // Calcular factor de salto din√°mico basado en cantidad de datos
                  const dynamicSkip = Math.max(1, Math.floor(chartData.length / 10));
                  if (value % dynamicSkip !== 0 && value !== chartData.length - 1) return '';
                  
                  if (chartData[value]) {
                    const date = new Date(chartData[value].timestamp);
                    return date.toLocaleString('es-ES', dateFormatConfig.format);
                  }
                  return '';
                },
                font: {
                  size: 10
                }
              },
              grid: {
                display: true,
                color: 'rgba(0, 0, 0, 0.05)'
              }
            },
            y: {
              display: true,
              position: 'right',
              ticks: {
                callback: function (value) {
                  return value.toFixed(2);  // Ajustado para acciones
                }
              }
            }
          },
          interaction: {
            mode: 'nearest',
            axis: 'x',
            intersect: false
          }
        }
      });

      // Bot√≥n para resetear zoom
      document.getElementById('resetZoom').addEventListener('click', function () {
        if (currentChart) {
          currentChart.resetZoom();
        }
      });
    }

    // Event listeners para los controles
    document.getElementById('loadDataBtn').addEventListener('click', function() {
      init();
    });

    // Agregar efecto hover al bot√≥n
    const loadBtn = document.getElementById('loadDataBtn');
    loadBtn.addEventListener('mouseenter', function() {
      this.style.transform = 'translateY(-2px)';
      this.style.boxShadow = '0 6px 16px rgba(102, 126, 234, 0.4)';
    });
    loadBtn.addEventListener('mouseleave', function() {
      this.style.transform = 'translateY(0)';
      this.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.3)';
    });

    // Actualizar autom√°ticamente cuando cambia el intervalo (ajustar l√≠mites)
    document.getElementById('intervalSelect').addEventListener('change', function() {
      const interval = this.value;
      const rangeSelect = document.getElementById('rangeSelect');
      
      // Mostrar advertencia si el intervalo tiene l√≠mites
      if (interval === '1m') {
        // M√°x 7 d√≠as para 1m
        if (parseFloat(rangeSelect.value) > 0.02) {
          rangeSelect.value = '0.02';  // 1 semana
        }
      } else if (interval === '5m' || interval === '15m') {
        // M√°x 60 d√≠as
        if (parseFloat(rangeSelect.value) > 0.17) {
          rangeSelect.value = '0.08';  // 1 mes
        }
      }
    });

    // ==========================================
    // FUNCI√ìN PARA MOSTRAR DETALLE DE VOTACI√ìN
    // ==========================================
    function showVotingDetail(signalElement) {
      const container = document.getElementById('votingDetailContainer');
      const strategyVotes = JSON.parse(signalElement.dataset.strategyVotes || '[]');
      const longVotes = parseInt(signalElement.dataset.longVotes) || 0;
      const shortVotes = parseInt(signalElement.dataset.shortVotes) || 0;
      const neutralVotes = parseInt(signalElement.dataset.neutralVotes) || 0;
      const finalSignal = parseInt(signalElement.dataset.finalSignal);
      const price = parseFloat(signalElement.dataset.price);
      const score = parseFloat(signalElement.dataset.score);
      const timestamp = signalElement.dataset.timestamp;
      
      // Actualizar t√≠tulo con fecha
      const signalDate = new Date(timestamp);
      const dateStr = signalDate.toLocaleString('es-ES', {
        weekday: 'short', day: '2-digit', month: 'short', year: 'numeric',
        hour: '2-digit', minute: '2-digit'
      });
      document.getElementById('votingTitle').innerHTML = 
        `Detalle de Votaci√≥n - <span style="color: #667eea;">${dateStr}</span> - Precio: <span style="color: #333;">$${price.toFixed(2)}</span>`;
      
      // Actualizar resumen
      const finalSignalText = finalSignal === 1 ? 'üü¢ LONG' : finalSignal === -1 ? 'üî¥ SHORT' : '‚ö™ NEUTRAL';
      const finalSignalColor = finalSignal === 1 ? '#2e7d32' : finalSignal === -1 ? '#c62828' : '#757575';
      document.getElementById('votingFinalSignal').innerHTML = `<span style="color: ${finalSignalColor}">${finalSignalText}</span>`;
      document.getElementById('votingLongCount').textContent = longVotes;
      document.getElementById('votingShortCount').textContent = shortVotes;
      document.getElementById('votingNeutralCount').textContent = neutralVotes;
      
      // Generar grid de estrategias
      const strategyGrid = document.getElementById('strategyVotesGrid');
      strategyGrid.innerHTML = '';
      
      // Nombres amigables para las estrategias
      const strategyNames = {
        'ema_crossover': 'üìà EMA Crossover',
        'rsi_reversal': 'üìä RSI Reversal',
        'macd_crossover': 'üìâ MACD Crossover',
        'bollinger_breakout': 'üìê Bollinger Breakout'
      };
      
      // Descripciones cortas
      const strategyDescriptions = {
        'ema_crossover': 'Cruces de medias m√≥viles exponenciales con filtros RSI/MACD',
        'rsi_reversal': 'Reversi√≥n desde zonas de sobrecompra/sobreventa',
        'macd_crossover': 'Cruces de MACD con confirmaci√≥n de momentum',
        'bollinger_breakout': 'Ruptura de bandas de Bollinger con tendencia fuerte'
      };
      
      strategyVotes.forEach(vote => {
        const voteColor = vote.vote === 'LONG' ? '#2e7d32' : vote.vote === 'SHORT' ? '#c62828' : '#757575';
        const voteBg = vote.vote === 'LONG' ? '#e8f5e9' : vote.vote === 'SHORT' ? '#ffebee' : '#f5f5f5';
        const voteBorder = vote.vote === 'LONG' ? '#a5d6a7' : vote.vote === 'SHORT' ? '#ef9a9a' : '#e0e0e0';
        const voteIcon = vote.vote === 'LONG' ? 'üü¢' : vote.vote === 'SHORT' ? 'üî¥' : '‚ö™';
        const scorePercent = (vote.score * 100).toFixed(0);
        
        const strategyCard = document.createElement('div');
        strategyCard.style.cssText = `
          background: ${voteBg};
          padding: 12px;
          border-radius: 8px;
          border: 2px solid ${voteBorder};
          transition: transform 0.2s ease;
        `;
        strategyCard.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
            <span style="font-weight: 600; font-size: 13px; color: #333;">${strategyNames[vote.name] || vote.name}</span>
            <span style="font-size: 16px;">${voteIcon}</span>
          </div>
          <div style="font-size: 20px; font-weight: bold; color: ${voteColor}; margin-bottom: 4px;">
            ${vote.vote}
          </div>
          <div style="font-size: 11px; color: #666; margin-bottom: 4px;">
            Score: <strong>${scorePercent}%</strong>
          </div>
          <div style="font-size: 10px; color: #888; line-height: 1.3;">
            ${strategyDescriptions[vote.name] || 'Estrategia de trading algor√≠tmico'}
          </div>
        `;
        
        strategyGrid.appendChild(strategyCard);
      });
      
      // Actualizar informaci√≥n adicional
      const totalVotes = longVotes + shortVotes + neutralVotes;
      const majority = Math.ceil(totalVotes / 2) + (totalVotes % 2 === 0 ? 1 : 0);
      const winningVotes = finalSignal === 1 ? longVotes : finalSignal === -1 ? shortVotes : 0;
      const votingInfo = document.getElementById('votingInfo');
      votingInfo.innerHTML = `
        <strong>üìä Metodolog√≠a:</strong> La se√±al final se determina por <em>votaci√≥n mayoritaria</em>. 
        Se requiere al menos <strong>${majority}/${totalVotes}</strong> votos para generar una se√±al. 
        ${finalSignal !== 0 ? `<br><strong>Resultado:</strong> ${winningVotes} de ${totalVotes} estrategias votaron ${finalSignal === 1 ? 'LONG' : 'SHORT'} (${((winningVotes/totalVotes)*100).toFixed(0)}% consenso).` : ''}
        <br><strong>Score final:</strong> ${(score * 100).toFixed(0)}% (promedio de estrategias coincidentes).
      `;
      
      // Mostrar contenedor
      container.style.display = 'block';
      
      // Scroll suave al contenedor de votaci√≥n
      container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    // Cargar datos iniciales
    init();

    // ==========================================
    // AUTO-REFRESH: Actualizaci√≥n autom√°tica cada minuto
    // ==========================================
    let autoRefreshInterval = null;
    let countdownInterval = null;
    let secondsUntilRefresh = 60;

    function startAutoRefresh() {
      // Actualizar cada 60 segundos (60000 ms)
      autoRefreshInterval = setInterval(() => {
        console.log('üîÑ Auto-refresh: Actualizando datos...');
        init();
        secondsUntilRefresh = 60;
      }, 60000);

      // Contador regresivo visible
      countdownInterval = setInterval(() => {
        secondsUntilRefresh--;
        if (secondsUntilRefresh < 0) secondsUntilRefresh = 60;
        updateRefreshIndicator();
      }, 1000);

      updateRefreshIndicator();
    }

    function updateRefreshIndicator() {
      const indicator = document.getElementById('refresh-indicator');
      if (indicator) {
        indicator.textContent = `üîÑ Auto-refresh en ${secondsUntilRefresh}s`;
      }
    }

    // Resetear contador cuando el usuario carga manualmente
    loadDataBtn.addEventListener('click', () => {
      secondsUntilRefresh = 60;
    });

    // Iniciar auto-refresh
    startAutoRefresh();
    console.log('‚úÖ Auto-refresh activado: actualizaci√≥n cada 60 segundos');

    // ==========================================
    // AN√ÅLISIS LLM: Funciones para generar an√°lisis con IA
    // ==========================================
    
    // Variable global para almacenar las se√±ales cargadas
    let loadedSignals = [];
    
    // Guardar se√±ales cuando se cargan
    const originalInit = init;
    init = async function() {
      await originalInit();
      // Guardar las se√±ales cargadas para el an√°lisis LLM
      const params = getSelectedParams();
      const url = `${API_BASE}/signals?ticker=${encodeURIComponent(params.ticker)}&years=${params.years}&interval=${params.interval}`;
      try {
        const response = await fetch(url);
        if (response.ok) {
          loadedSignals = await response.json();
          console.log('üìä Se√±ales guardadas para an√°lisis LLM:', loadedSignals.filter(s => s.signal !== 0).length);
        }
      } catch (e) {
        console.error('Error guardando se√±ales para LLM:', e);
      }
    };
    
    async function generateLLMAnalysis() {
      const btn = document.getElementById('generateAnalysisBtn');
      const btnIcon = document.getElementById('analysisButtonIcon');
      const btnText = document.getElementById('analysisButtonText');
      const loadingIndicator = document.getElementById('analysisLoadingIndicator');
      const analysisContent = document.getElementById('analysisContent');
      const analysisEmpty = document.getElementById('analysisEmpty');
      const analysisError = document.getElementById('analysisError');
      
      // Obtener par√°metros actuales
      const params = getSelectedParams();
      
      // Verificar si hay se√±ales
      const activeSignals = loadedSignals.filter(s => s.signal !== 0);
      if (activeSignals.length === 0) {
        alert('‚ö†Ô∏è No hay se√±ales activas para analizar. Carga datos con se√±ales primero.');
        return;
      }
      
      // Deshabilitar bot√≥n y mostrar loading
      btn.disabled = true;
      btnIcon.textContent = '‚è≥';
      btnText.textContent = 'Analizando...';
      loadingIndicator.style.display = 'block';
      analysisContent.style.display = 'none';
      analysisEmpty.style.display = 'none';
      analysisError.style.display = 'none';
      
      console.log('ü§ñ Generando an√°lisis LLM para', params.ticker, 'con', activeSignals.length, 'se√±ales');
      
      try {
        const response = await fetch(`${API_BASE}/analysis`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            ticker: params.ticker,
            signals: loadedSignals,
            use_cache: true
          })
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        console.log('‚úÖ An√°lisis recibido:', result);
        
        // Mostrar resultados
        document.getElementById('analysisSignalCount').textContent = result.signal_count;
        document.getElementById('analysisCacheStatus').innerHTML = result.cached 
          ? '<span style="color: #81c784;">‚úì Desde cach√©</span>' 
          : '<span style="color: #4fc3f7;">‚úì Nuevo</span>';
        
        // Formatear y mostrar el texto del an√°lisis
        const formattedAnalysis = formatAnalysisText(result.analysis);
        document.getElementById('analysisText').innerHTML = formattedAnalysis;
        
        // Mostrar error si existe
        if (result.error) {
          document.getElementById('analysisErrorText').textContent = result.error;
          analysisError.style.display = 'block';
        }
        
        // Mostrar contenido
        loadingIndicator.style.display = 'none';
        analysisContent.style.display = 'block';
        
        // Auto-expandir el acorde√≥n
        document.getElementById('analysisAccordionContent').style.display = 'block';
        document.getElementById('accordionIcon').style.transform = 'rotate(180deg)';
        
      } catch (error) {
        console.error('‚ùå Error en an√°lisis LLM:', error);
        loadingIndicator.style.display = 'none';
        analysisEmpty.style.display = 'block';
        analysisEmpty.innerHTML = `
          <p style="margin: 0; font-size: 13px; color: #f44336;">
            <strong>‚ùå Error:</strong> ${error.message}
          </p>
          <p style="margin: 8px 0 0 0; font-size: 12px; color: #a0a0a0;">
            Verifica que la API est√© corriendo y que Google Gemini est√© configurado.
          </p>
        `;
      } finally {
        // Rehabilitar bot√≥n
        btn.disabled = false;
        btnIcon.textContent = '‚ú®';
        btnText.textContent = 'Generar An√°lisis';
      }
    }
    
    function toggleAnalysisAccordion() {
      const content = document.getElementById('analysisAccordionContent');
      const icon = document.getElementById('accordionIcon');
      
      if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.style.transform = 'rotate(180deg)';
      } else {
        content.style.display = 'none';
        icon.style.transform = 'rotate(0deg)';
      }
    }
    
    function formatAnalysisText(text) {
      // Convertir markdown b√°sico a HTML
      let formatted = text
        // Headers
        .replace(/^### (.*$)/gim, '<h3>$1</h3>')
        .replace(/^## (.*$)/gim, '<h2>$1</h2>')
        .replace(/^# (.*$)/gim, '<h1>$1</h1>')
        // Bold
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        // Italic
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        // Code
        .replace(/`(.*?)`/g, '<code>$1</code>')
        // Line breaks
        .replace(/\n/g, '<br>')
        // Tags especiales del an√°lisis
        .replace(/&lt;analisis&gt;/g, '<div style="background: rgba(79, 195, 247, 0.1); border-left: 3px solid #4fc3f7; padding: 12px; margin: 12px 0; border-radius: 0 8px 8px 0;"><strong style="color: #4fc3f7;">üìä An√°lisis:</strong><br>')
        .replace(/&lt;\/analisis&gt;/g, '</div>')
        .replace(/<analisis>/g, '<div style="background: rgba(79, 195, 247, 0.1); border-left: 3px solid #4fc3f7; padding: 12px; margin: 12px 0; border-radius: 0 8px 8px 0;"><strong style="color: #4fc3f7;">üìä An√°lisis:</strong><br>')
        .replace(/<\/analisis>/g, '</div>')
        .replace(/&lt;explicacion_se√±al&gt;/g, '<div style="background: rgba(233, 69, 96, 0.1); border-left: 3px solid #e94560; padding: 12px; margin: 12px 0; border-radius: 0 8px 8px 0;"><strong style="color: #e94560;">üìù Explicaci√≥n:</strong><br>')
        .replace(/&lt;\/explicacion_se√±al&gt;/g, '</div>')
        .replace(/<explicacion_se√±al>/g, '<div style="background: rgba(233, 69, 96, 0.1); border-left: 3px solid #e94560; padding: 12px; margin: 12px 0; border-radius: 0 8px 8px 0;"><strong style="color: #e94560;">üìù Explicaci√≥n:</strong><br>')
        .replace(/<\/explicacion_se√±al>/g, '</div>')
        // Se√±ales destacadas
        .replace(/LONG/g, '<span style="color: #81c784; font-weight: bold;">LONG</span>')
        .replace(/SHORT/g, '<span style="color: #ef5350; font-weight: bold;">SHORT</span>')
        // Separador de se√±ales
        .replace(/---\s*SE√ëAL/g, '<hr style="border: none; border-top: 2px solid #0f3460; margin: 20px 0;"><strong style="color: #e94560; font-size: 16px;">üìç SE√ëAL');
      
      return formatted;
    }
    
    // Resetear an√°lisis cuando se cambian los datos
    loadDataBtn.addEventListener('click', () => {
      // Resetear el contenedor de an√°lisis
      document.getElementById('analysisContent').style.display = 'none';
      document.getElementById('analysisEmpty').style.display = 'block';
      document.getElementById('analysisEmpty').innerHTML = '<p style="margin: 0; font-size: 13px;">Presiona <strong style="color: #e94560;">"Generar An√°lisis"</strong> para obtener una explicaci√≥n detallada de las se√±ales.</p>';
      document.getElementById('analysisAccordionContent').style.display = 'none';
      document.getElementById('accordionIcon').style.transform = 'rotate(0deg)';
    });
    
    console.log('‚úÖ Sistema de an√°lisis LLM cargado');
  </script>
</body>

</html>