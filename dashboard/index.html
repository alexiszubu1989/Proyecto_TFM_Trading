<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TFM Trading Dashboard</title>
  <style>
    :root {
      --color-bg: #f5f5f5;
      --color-surface: #ffffff;
      --color-border: #e0e0e0;
      --color-border-light: #eee;
      --color-text: #333;
      --color-text-muted: #666;
      --color-text-light: #999;
      --color-primary: #667eea;
      --color-primary-light: #e8f0fe;
      --color-success: #0a7f42;
      --color-success-light: #e8f5e9;
      --color-danger: #b00020;
      --color-danger-light: #ffebee;
      --color-neutral: #757575;
      --color-accent: #00b4d8;
      --color-accent-dark: #0077b6;
      --color-dark: #1a1a2e;
      --color-dark-secondary: #16213e;
      --color-dark-border: #0f3460;
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 12px;
      --spacing-lg: 16px;
      --spacing-xl: 20px;
      --radius-sm: 4px;
      --radius-md: 6px;
      --radius-lg: 8px;
      --radius-xl: 10px;
      --shadow-sm: 0 2px 4px rgba(0,0,0,0.08);
      --shadow-md: 0 2px 8px rgba(0,0,0,0.08);
      --shadow-lg: 0 4px 12px rgba(0,0,0,0.1);
      --font-xs: 10px;
      --font-sm: 11px;
      --font-md: 12px;
      --font-base: 13px;
      --font-lg: 14px;
      --font-xl: 16px;
      --font-2xl: 18px;
      --font-3xl: 22px;
      --font-4xl: 24px;
      --transition-fast: 0.2s ease;
      --transition-normal: 0.3s ease;
    }

    * { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      margin: var(--spacing-lg);
      background: var(--color-bg);
      color: var(--color-text);
      line-height: 1.5;
    }

    /* Layout */
    .grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: var(--spacing-lg);
    }

    .card {
      border: 1px solid var(--color-border);
      border-radius: var(--radius-xl);
      padding: var(--spacing-lg);
      box-shadow: var(--shadow-md);
      background: var(--color-surface);
    }

    .card--gradient {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    }

    .card--dark {
      background: linear-gradient(135deg, var(--color-dark) 0%, var(--color-dark-secondary) 100%);
      border-color: var(--color-dark-border);
    }

    /* Typography */
    .title {
      margin: 0 0 var(--spacing-sm) 0;
      font-size: var(--font-xl);
      font-weight: 600;
    }

    .subtitle {
      margin: 0;
      font-size: var(--font-md);
      color: var(--color-text-muted);
    }

    .label {
      display: block;
      font-size: var(--font-md);
      font-weight: 600;
      color: var(--color-text);
      margin-bottom: var(--spacing-sm);
    }

    .text-muted {
      color: var(--color-text-muted);
      font-size: var(--font-md);
    }

    .text-xs {
      font-size: var(--font-xs);
    }

    .text-sm {
      font-size: var(--font-sm);
    }

    .text-uppercase {
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Controls */
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-lg);
      align-items: flex-end;
    }

    .control-group {
      flex: 1;
      min-width: 150px;
    }

    .control-group--wide {
      min-width: 180px;
    }

    .select {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid var(--color-primary);
      border-radius: var(--radius-lg);
      font-size: var(--font-lg);
      background: var(--color-surface);
      cursor: pointer;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-sm);
      padding: 10px 20px;
      border: none;
      border-radius: var(--radius-lg);
      font-size: var(--font-lg);
      font-weight: 600;
      cursor: pointer;
      transition: transform var(--transition-fast), box-shadow var(--transition-fast);
    }

    .btn:hover {
      transform: translateY(-2px);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn--primary {
      background: linear-gradient(135deg, var(--color-primary) 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .btn--accent {
      background: linear-gradient(135deg, var(--color-accent) 0%, var(--color-accent-dark) 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(0, 180, 216, 0.3);
    }

    .btn--danger {
      background: linear-gradient(135deg, #e94560 0%, #0f3460 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(233, 69, 96, 0.3);
    }

    .btn--small {
      padding: 6px 12px;
      font-size: var(--font-md);
    }

    .btn--full {
      width: 100%;
    }

    /* Tables */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: var(--font-base);
    }

    th, td {
      border-bottom: 1px solid var(--color-border-light);
      padding: var(--spacing-sm);
      text-align: right;
    }

    th:first-child, td:first-child {
      text-align: left;
    }

    th {
      background: #fafafa;
      font-weight: 600;
    }

    /* Signals */
    .signal-long {
      color: var(--color-success);
      font-weight: bold;
    }

    .signal-short {
      color: var(--color-danger);
      font-weight: bold;
    }

    .signal-neutral {
      color: var(--color-text-muted);
    }

    .signals-container {
      max-height: 600px;
      overflow-y: auto;
      overflow-x: hidden;
      padding-right: var(--spacing-sm);
    }

    .signals-container::-webkit-scrollbar {
      width: 8px;
    }

    .signals-container::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: var(--radius-sm);
    }

    .signals-container::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: var(--radius-sm);
    }

    .signal-item {
      border-bottom: 1px solid var(--color-border-light);
      padding: var(--spacing-md) 0;
      cursor: pointer;
      transition: background var(--transition-fast);
    }

    .signal-item:hover {
      background: #f8f8f8;
      border-radius: var(--radius-sm);
      padding-left: var(--spacing-sm);
    }

    .signal-item:last-child {
      border-bottom: none;
    }

    .signal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-sm);
    }

    .signal-type {
      font-weight: bold;
      font-size: var(--font-lg);
    }

    .signal-time {
      font-size: var(--font-sm);
      color: var(--color-text-light);
    }

    .signal-details {
      font-size: var(--font-md);
      color: var(--color-text-muted);
      line-height: 1.6;
    }

    .signal-price {
      font-size: var(--font-lg);
      font-weight: 600;
      margin: var(--spacing-xs) 0;
    }

    /* Stats */
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--spacing-sm);
      margin-top: var(--spacing-md);
    }

    .stat-box {
      background: #fafafa;
      padding: 10px;
      border-radius: var(--radius-md);
      text-align: center;
      border: 1px solid var(--color-border-light);
    }

    .stat-label {
      font-size: var(--font-sm);
      color: var(--color-text-muted);
      text-transform: uppercase;
      margin-bottom: var(--spacing-xs);
    }

    .stat-value {
      font-size: var(--font-xl);
      font-weight: bold;
    }

    /* Active Signal Box */
    .active-signal-box {
      background: linear-gradient(135deg, var(--color-primary) 0%, #764ba2 100%);
      color: white;
      padding: var(--spacing-lg);
      border-radius: var(--radius-lg);
      margin-bottom: var(--spacing-lg);
    }

    .active-signal-box h3 {
      margin: 0 0 var(--spacing-sm) 0;
      font-size: var(--font-md);
      text-transform: uppercase;
      letter-spacing: 1px;
      opacity: 0.9;
    }

    .active-signal-type {
      font-size: var(--font-2xl);
      font-weight: bold;
      margin-bottom: var(--spacing-md);
    }

    .active-signal-details {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: var(--spacing-sm);
    }

    .detail-item {
      background: rgba(255, 255, 255, 0.15);
      padding: 6px 10px;
      border-radius: var(--radius-md);
    }

    .detail-label {
      font-size: var(--font-xs);
      opacity: 0.8;
      text-transform: uppercase;
    }

    .detail-value {
      font-weight: bold;
      font-size: var(--font-lg);
      margin-top: 2px;
    }

    /* Period Info */
    .period-info {
      background: #f0f7ff;
      padding: var(--spacing-md);
      border-radius: var(--radius-md);
      margin-top: var(--spacing-md);
      font-size: var(--font-md);
    }

    /* Loading */
    .loading-overlay {
      display: none;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255,255,255,0.9);
      padding: 20px 40px;
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-lg);
      z-index: 100;
      text-align: center;
    }

    .loading-text {
      font-weight: 600;
      margin-top: 10px;
    }

    /* KPI Grid */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-bottom: var(--spacing-lg);
    }

    .kpi-box {
      padding: var(--spacing-md);
      border-radius: var(--radius-lg);
      text-align: center;
    }

    .kpi-box--default {
      background: rgba(65, 90, 119, 0.3);
      border: 1px solid #415a77;
    }

    .kpi-box--success {
      background: rgba(16, 185, 129, 0.15);
      border: 1px solid #10b981;
    }

    .kpi-box--danger {
      background: rgba(239, 68, 68, 0.15);
      border: 1px solid #ef4444;
    }

    .kpi-label {
      font-size: var(--font-xs);
      color: #a0a0a0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .kpi-value {
      font-size: var(--font-3xl);
      font-weight: bold;
      margin-top: var(--spacing-xs);
    }

    .kpi-value--small {
      font-size: var(--font-xl);
    }

    .kpi-value--success {
      color: #10b981;
    }

    .kpi-value--danger {
      color: #ef4444;
    }

    .kpi-value--accent {
      color: var(--color-accent);
    }

    .kpi-value--light {
      color: #e0e1dd;
    }

    /* Voting Detail */
    .voting-container {
      display: none;
      margin-top: var(--spacing-lg);
      background: linear-gradient(135deg, #f8f9ff 0%, #e8f4ff 100%);
      border-radius: var(--radius-xl);
      padding: var(--spacing-lg);
      border: 2px solid var(--color-primary);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.15);
    }

    .voting-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-md);
    }

    .voting-title {
      margin: 0;
      color: var(--color-text);
      font-size: 15px;
    }

    .voting-close {
      background: #ff5252;
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      font-size: var(--font-lg);
      line-height: 1;
    }

    .voting-summary {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-bottom: var(--spacing-lg);
    }

    .vote-box {
      padding: 10px;
      border-radius: var(--radius-lg);
      text-align: center;
    }

    .vote-box--default {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
    }

    .vote-box--long {
      background: var(--color-success-light);
      border: 1px solid #a5d6a7;
    }

    .vote-box--short {
      background: var(--color-danger-light);
      border: 1px solid #ef9a9a;
    }

    .vote-box--neutral {
      background: #f5f5f5;
      border: 1px solid var(--color-border);
    }

    .vote-label {
      font-size: var(--font-sm);
      text-transform: uppercase;
    }

    .vote-value {
      font-size: var(--font-2xl);
      font-weight: bold;
      margin-top: var(--spacing-xs);
    }

    .strategy-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .strategy-card {
      padding: var(--spacing-md);
      border-radius: var(--radius-lg);
      border: 2px solid;
      transition: transform var(--transition-fast);
    }

    .strategy-card:hover {
      transform: translateY(-2px);
    }

    .voting-info {
      margin-top: var(--spacing-lg);
      padding: 10px;
      background: rgba(102, 126, 234, 0.1);
      border-radius: var(--radius-lg);
      font-size: var(--font-md);
      color: #555;
    }

    /* Analysis Section */
    .analysis-container {
      margin-top: var(--spacing-lg);
      background: linear-gradient(135deg, var(--color-dark) 0%, var(--color-dark-secondary) 100%);
      border-radius: var(--radius-xl);
      padding: var(--spacing-lg);
      border: 2px solid var(--color-dark-border);
      box-shadow: 0 4px 20px rgba(15, 52, 96, 0.3);
    }

    .analysis-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-md);
    }

    .analysis-title {
      margin: 0;
      color: #e94560;
      font-size: var(--font-xl);
    }

    .analysis-info {
      background: rgba(233, 69, 96, 0.1);
      border-radius: var(--radius-lg);
      padding: 10px;
      margin-bottom: var(--spacing-md);
      border-left: 3px solid #e94560;
    }

    .analysis-loading {
      display: none;
      text-align: center;
      padding: 40px 20px;
    }

    .spinner {
      display: inline-block;
      position: relative;
      width: 80px;
      height: 80px;
    }

    .spinner-ring {
      position: absolute;
      border: 4px solid transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .spinner-ring--outer {
      width: 60px;
      height: 60px;
      border-top-color: #e94560;
    }

    .spinner-ring--middle {
      width: 45px;
      height: 45px;
      top: 7.5px;
      left: 7.5px;
      border-top-color: #0f3460;
      animation-direction: reverse;
      animation-duration: 1.5s;
    }

    .spinner-ring--inner {
      width: 30px;
      height: 30px;
      top: 15px;
      left: 15px;
      border-top-color: #533483;
      animation-duration: 2s;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .analysis-content {
      display: none;
    }

    .analysis-summary {
      background: rgba(15, 52, 96, 0.5);
      border-radius: var(--radius-lg);
      padding: var(--spacing-md);
      margin-bottom: var(--spacing-md);
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }

    .analysis-stat {
      text-align: center;
    }

    .analysis-stat-label {
      font-size: var(--font-sm);
      color: #a0a0a0;
      text-transform: uppercase;
    }

    .analysis-stat-value {
      font-size: var(--font-4xl);
      font-weight: bold;
      color: #e94560;
    }

    .accordion {
      border-radius: var(--radius-lg);
      overflow: hidden;
    }

    .accordion-header {
      background: linear-gradient(135deg, #0f3460 0%, #533483 100%);
      padding: 14px 16px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all var(--transition-normal);
    }

    .accordion-header span {
      color: white;
      font-weight: bold;
      font-size: var(--font-lg);
    }

    .accordion-icon {
      color: white;
      font-size: var(--font-2xl);
      transition: transform var(--transition-normal);
    }

    .accordion-content {
      display: none;
      background: rgba(26, 26, 46, 0.8);
      padding: var(--spacing-lg);
      max-height: 500px;
      overflow-y: auto;
    }

    .analysis-text {
      color: #e0e0e0;
      font-size: var(--font-base);
      line-height: 1.8;
      white-space: pre-wrap;
      font-family: 'Segoe UI', system-ui, sans-serif;
    }

    .analysis-text h1, 
    .analysis-text h2, 
    .analysis-text h3 {
      color: #e94560;
      margin-top: var(--spacing-lg);
      margin-bottom: var(--spacing-sm);
    }

    .analysis-text strong {
      color: #4fc3f7;
    }

    .analysis-text em {
      color: #81c784;
    }

    .analysis-text code {
      background: rgba(233, 69, 96, 0.2);
      padding: 2px 6px;
      border-radius: var(--radius-sm);
      font-family: 'Consolas', monospace;
    }

    .analysis-empty {
      text-align: center;
      padding: var(--spacing-xl);
      color: #a0a0a0;
    }

    .analysis-error {
      display: none;
      background: rgba(244, 67, 54, 0.1);
      border: 1px solid #f44336;
      border-radius: var(--radius-lg);
      padding: var(--spacing-md);
      margin-top: var(--spacing-md);
    }

    .analysis-error p {
      margin: 0;
      color: #f44336;
      font-size: var(--font-md);
    }

    /* Backtest Section */
    .backtest-container {
      margin-top: var(--spacing-lg);
      background: linear-gradient(135deg, #0d1b2a 0%, #1b263b 100%);
      border-radius: var(--radius-xl);
      padding: var(--spacing-lg);
      border: 2px solid #415a77;
      box-shadow: 0 4px 20px rgba(65, 90, 119, 0.3);
    }

    .backtest-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-md);
    }

    .backtest-title {
      margin: 0;
      color: var(--color-accent);
      font-size: var(--font-xl);
    }

    .backtest-info {
      background: rgba(0, 180, 216, 0.1);
      border-radius: var(--radius-lg);
      padding: 10px;
      margin-bottom: var(--spacing-md);
      border-left: 3px solid var(--color-accent);
    }

    .backtest-loading {
      display: none;
      text-align: center;
      padding: 40px 20px;
    }

    .backtest-content {
      display: none;
    }

    .backtest-capital {
      background: rgba(27, 38, 59, 0.8);
      border-radius: var(--radius-lg);
      padding: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .backtest-capital-label {
      font-size: var(--font-base);
      font-weight: bold;
      color: #e0e1dd;
    }

    .backtest-capital-value {
      font-size: var(--font-base);
      color: #778da9;
    }

    .bt-accordion-header {
      background: linear-gradient(135deg, #415a77 0%, #1b263b 100%);
      padding: 12px 16px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all var(--transition-normal);
    }

    .bt-accordion-header span {
      color: white;
      font-weight: bold;
      font-size: var(--font-base);
    }

    .trades-table {
      width: 100%;
      border-collapse: collapse;
      font-size: var(--font-md);
    }

    .trades-table thead {
      background: rgba(65, 90, 119, 0.5);
      position: sticky;
      top: 0;
    }

    .trades-table th {
      padding: 10px 8px;
      text-align: left;
      color: #778da9;
      font-weight: 600;
    }

    .trades-table td {
      padding: 10px 8px;
      border-bottom: 1px solid rgba(65, 90, 119, 0.3);
    }

    .trades-content {
      display: none;
      background: rgba(13, 27, 42, 0.9);
      max-height: 400px;
      overflow-y: auto;
    }

    .backtest-empty {
      text-align: center;
      padding: var(--spacing-xl);
      color: #a0a0a0;
    }

    .backtest-error {
      display: none;
      background: rgba(244, 67, 54, 0.1);
      border: 1px solid #f44336;
      border-radius: var(--radius-lg);
      padding: var(--spacing-md);
      margin-top: var(--spacing-md);
    }

    /* Badges */
    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 10px;
      font-size: var(--font-xs);
      font-weight: bold;
    }

    .badge--primary {
      background: var(--color-primary);
      color: white;
    }

    .badge--success {
      background: rgba(16, 185, 129, 0.2);
      color: #10b981;
    }

    .badge--danger {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }

    .trade-side {
      display: inline-block;
      padding: 3px 8px;
      border-radius: var(--radius-sm);
      font-weight: bold;
      font-size: var(--font-sm);
    }

    .trade-side--long {
      background: rgba(16, 185, 129, 0.2);
      color: #10b981;
    }

    .trade-side--short {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }

    /* Chart */
    .chart-container {
      width: 100%;
      height: 380px;
      position: relative;
    }

    .chart-help {
      margin-top: var(--spacing-sm);
      font-size: var(--font-sm);
      color: var(--color-text-muted);
    }

    /* Refresh Indicator */
    .refresh-indicator {
      float: right;
      font-size: var(--font-base);
      font-weight: normal;
      color: var(--color-primary);
      background: var(--color-primary-light);
      padding: 4px 12px;
      border-radius: 20px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr;
      }

      .controls {
        flex-direction: column;
      }

      .control-group {
        width: 100%;
      }

      .kpi-grid,
      .voting-summary {
        grid-template-columns: repeat(2, 1fr);
      }

      .active-signal-details {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>

<body>
  <h2 class="title">
    TFM Trading Dashboard
    <small class="text-muted">(Universidad Internacional de la Rioja (UNIR))</small>
    <span id="refresh-indicator" class="refresh-indicator">Auto-refresh: 60s</span>
  </h2>
  <p class="subtitle">Herramienta educativa. No constituye asesoría financiera.</p>

  <div class="card card--gradient" style="margin-bottom: var(--spacing-lg);">
    <div class="controls">
      <div class="control-group control-group--wide">
        <label class="label">Ticker</label>
        <select id="tickerSelect" class="select">
          <option value="AAPL">AAPL - Apple Inc.</option>
          <option value="MSFT">MSFT - Microsoft</option>
          <option value="GOOGL">GOOGL - Alphabet</option>
          <option value="AMZN">AMZN - Amazon</option>
          <option value="TSLA">TSLA - Tesla</option>
          <option value="META">META - Meta Platforms</option>
          <option value="NVDA">NVDA - NVIDIA</option>
          <option value="JPM">JPM - JPMorgan Chase</option>
          <option value="V">V - Visa Inc.</option>
          <option value="JNJ">JNJ - Johnson & Johnson</option>
          <option value="EURUSD=X">EUR/USD</option>
          <option value="GBPUSD=X">GBP/USD</option>
          <option value="USDJPY=X">USD/JPY</option>
          <option value="BTC-USD">BTC/USD</option>
          <option value="ETH-USD">ETH/USD</option>
          <option value="SPY">SPY - S&P 500 ETF</option>
          <option value="QQQ">QQQ - NASDAQ 100 ETF</option>
        </select>
      </div>

      <div class="control-group">
        <label class="label">Rango Temporal</label>
        <select id="rangeSelect" class="select">
          <option value="0.02">1 Semana</option>
          <option value="0.08">1 Mes</option>
          <option value="0.25">3 Meses</option>
          <option value="0.5" selected>6 Meses</option>
          <option value="1">1 Año</option>
          <option value="2">2 Años</option>
          <option value="5">5 Años</option>
        </select>
      </div>

      <div class="control-group">
        <label class="label">Intervalo</label>
        <select id="intervalSelect" class="select">
          <option value="1m">1 Minuto</option>
          <option value="5m" selected>5 Minutos</option>
          <option value="15m">15 Minutos</option>
          <option value="1h">1 Hora</option>
          <option value="1d">1 Día</option>
          <option value="1mo">1 Mes</option>
        </select>
      </div>

      <div class="control-group">
        <button id="loadDataBtn" class="btn btn--primary btn--full">Cargar Datos</button>
      </div>
    </div>
    <p id="dataLimitWarning" class="text-muted text-sm" style="margin: 10px 0 0 0;">
      <strong>Límites de Yahoo Finance:</strong> 1m (7 días), 5m/15m (60 días), 1h (2 años), 1d/1mo (sin límite).
    </p>
    <p id="currentLimitInfo" class="text-sm" style="margin: 5px 0 0 0; color: #e65100; display: none;"></p>
  </div>

  <div class="grid">
    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-sm);">
        <h3 class="title" style="margin: 0;">Precio con Señales - <span id="currentTicker">AAPL</span></h3>
        <button id="resetZoom" class="btn btn--primary btn--small">Resetear Zoom</button>
      </div>
      
      <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-text">Cargando datos...</div>
      </div>
      
      <div id="chartContainer" class="chart-container">
        <canvas id="priceChart"></canvas>
      </div>
      <p id="chartNavHelp" class="chart-help">
        Rueda del mouse para zoom | Arrastrar para pan | "Resetear Zoom" para vista original
      </p>

      <!-- Voting Detail Container -->
      <div id="votingDetailContainer" class="voting-container">
        <div class="voting-header">
          <h4 id="votingTitle" class="voting-title">Detalle de Votación</h4>
          <button id="closeVotingDetail" class="voting-close" onclick="TradingApp.ui.hideVotingDetail()">×</button>
        </div>
        
        <div id="votingSummary" class="voting-summary">
          <div class="vote-box vote-box--default">
            <div class="vote-label">Señal Final</div>
            <div id="votingFinalSignal" class="vote-value">—</div>
          </div>
          <div class="vote-box vote-box--long">
            <div class="vote-label" style="color: var(--color-success);">Votos LONG</div>
            <div id="votingLongCount" class="vote-value" style="color: var(--color-success);">0</div>
          </div>
          <div class="vote-box vote-box--short">
            <div class="vote-label" style="color: var(--color-danger);">Votos SHORT</div>
            <div id="votingShortCount" class="vote-value" style="color: var(--color-danger);">0</div>
          </div>
          <div class="vote-box vote-box--neutral">
            <div class="vote-label">Neutral</div>
            <div id="votingNeutralCount" class="vote-value" style="color: var(--color-neutral);">0</div>
          </div>
        </div>
        
        <div id="strategyVotesGrid" class="strategy-grid"></div>
        
        <div id="votingInfo" class="voting-info">
          La señal final se determina por votación mayoritaria. Se requiere que al menos la mitad +1 de las estrategias coincidan.
        </div>
      </div>

      <!-- LLM Analysis Container -->
      <div id="llmAnalysisContainer" class="analysis-container">
        <div class="analysis-header">
          <h4 class="analysis-title">Análisis con IA</h4>
          <button id="generateAnalysisBtn" onclick="TradingApp.analysis.generate()" class="btn btn--danger">
            <span id="analysisButtonIcon">+</span>
            <span id="analysisButtonText">Generar Análisis</span>
          </button>
        </div>
        
        <div class="analysis-info">
          <p class="text-muted text-sm" style="margin: 0; line-height: 1.5;">
            <strong style="color: #e94560;">Análisis:</strong> Usa Google Gemini para explicar cada señal, las estrategias evaluadas y la gestión de riesgo.
          </p>
        </div>
        
        <div id="analysisLoadingIndicator" class="analysis-loading">
          <div class="spinner">
            <div class="spinner-ring spinner-ring--outer"></div>
            <div class="spinner-ring spinner-ring--middle"></div>
            <div class="spinner-ring spinner-ring--inner"></div>
          </div>
          <p style="margin-top: var(--spacing-lg); color: #e94560; font-weight: bold;">Analizando señales...</p>
          <p class="text-muted text-sm">Esto puede tomar unos segundos</p>
        </div>
        
        <div id="analysisContent" class="analysis-content">
          <div id="analysisSummary" class="analysis-summary">
            <div class="analysis-stat">
              <div class="analysis-stat-label">Señales Analizadas</div>
              <div id="analysisSignalCount" class="analysis-stat-value">0</div>
            </div>
            <div class="analysis-stat">
              <div class="analysis-stat-label">Fuente</div>
              <div style="font-size: var(--font-xl); font-weight: bold; color: #4fc3f7; margin-top: var(--spacing-xs);">Google Gemini</div>
            </div>
            <div class="analysis-stat">
              <div class="analysis-stat-label">Estado</div>
              <div id="analysisCacheStatus" style="font-size: var(--font-xl); font-weight: bold; color: #81c784; margin-top: var(--spacing-xs);">—</div>
            </div>
          </div>
          
          <div class="accordion">
            <div class="accordion-header" onclick="TradingApp.ui.toggleAccordion('analysis')">
              <span>Ver Análisis Detallado</span>
              <span id="accordionIcon" class="accordion-icon">▼</span>
            </div>
            <div id="analysisAccordionContent" class="accordion-content">
              <div id="analysisText" class="analysis-text"></div>
            </div>
          </div>
          
          <div id="analysisError" class="analysis-error">
            <p><strong>Aviso:</strong> <span id="analysisErrorText"></span></p>
          </div>
        </div>
        
        <div id="analysisEmpty" class="analysis-empty">
          <p style="margin: 0; font-size: var(--font-base);">Presiona <strong style="color: #e94560;">"Generar Análisis"</strong> para obtener una explicación detallada.</p>
        </div>
      </div>

      <!-- Backtest Container -->
      <div id="backtestContainer" class="backtest-container">
        <div class="backtest-header">
          <h4 class="backtest-title">Backtest - Resultados</h4>
          <button id="runBacktestBtn" onclick="TradingApp.backtest.run()" class="btn btn--accent">
            <span id="backtestButtonIcon">▶</span>
            <span id="backtestButtonText">Ejecutar Backtest</span>
          </button>
        </div>
        
        <div class="backtest-info">
          <p class="text-muted text-sm" style="margin: 0; line-height: 1.5;">
            <strong style="color: var(--color-accent);">Función:</strong> Simula la ejecución de todas las señales del período, calculando el rendimiento con gestión de riesgo.
          </p>
        </div>
        
        <div id="backtestLoadingIndicator" class="backtest-loading">
          <div class="spinner">
            <div class="spinner-ring spinner-ring--outer" style="border-top-color: var(--color-accent);"></div>
            <div class="spinner-ring spinner-ring--middle" style="border-top-color: #415a77;"></div>
            <div class="spinner-ring spinner-ring--inner" style="border-top-color: #1b263b;"></div>
          </div>
          <p style="margin-top: var(--spacing-lg); color: var(--color-accent); font-weight: bold;">Ejecutando backtest...</p>
        </div>
        
        <div id="backtestContent" class="backtest-content">
          <div class="kpi-grid">
            <div class="kpi-box kpi-box--default">
              <div class="kpi-label">Trades</div>
              <div id="btTotalTrades" class="kpi-value kpi-value--accent">0</div>
            </div>
            <div class="kpi-box kpi-box--success">
              <div class="kpi-label">Win Rate</div>
              <div id="btWinRate" class="kpi-value kpi-value--success">0%</div>
            </div>
            <div id="btPnlBox" class="kpi-box kpi-box--default">
              <div class="kpi-label">PnL Total</div>
              <div id="btTotalPnl" class="kpi-value">$0</div>
            </div>
            <div class="kpi-box kpi-box--danger">
              <div class="kpi-label">Max DD</div>
              <div id="btMaxDD" class="kpi-value kpi-value--danger">0%</div>
            </div>
          </div>
          
          <div class="kpi-grid">
            <div class="kpi-box kpi-box--default">
              <div class="kpi-label">Sharpe</div>
              <div id="btSharpe" class="kpi-value kpi-value--small kpi-value--light">0.00</div>
            </div>
            <div class="kpi-box kpi-box--default">
              <div class="kpi-label">Profit Factor</div>
              <div id="btProfitFactor" class="kpi-value kpi-value--small kpi-value--light">0.00</div>
            </div>
            <div class="kpi-box kpi-box--default">
              <div class="kpi-label">Mejor Trade</div>
              <div id="btBestTrade" class="kpi-value kpi-value--small kpi-value--success">$0</div>
            </div>
            <div class="kpi-box kpi-box--default">
              <div class="kpi-label">Peor Trade</div>
              <div id="btWorstTrade" class="kpi-value kpi-value--small kpi-value--danger">$0</div>
            </div>
          </div>
          
          <div class="backtest-capital">
            <span class="backtest-capital-label">Capital</span>
            <div class="backtest-capital-value">
              <span id="btInitialCapital">$10,000</span> → <span id="btFinalEquity" style="font-weight: bold; color: var(--color-accent);">$10,000</span>
            </div>
          </div>
          
          <div class="accordion" style="border-radius: var(--radius-lg); overflow: hidden;">
            <div class="bt-accordion-header" onclick="TradingApp.ui.toggleAccordion('backtest')">
              <span>Ver Detalle de Trades (<span id="btTradeCount">0</span>)</span>
              <span id="btAccordionIcon" class="accordion-icon">▼</span>
            </div>
            <div id="backtestTradesContent" class="trades-content">
              <table class="trades-table">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Fecha</th>
                    <th>Tipo</th>
                    <th style="text-align: right;">Entrada</th>
                    <th style="text-align: right;">Salida</th>
                    <th style="text-align: right;">PnL</th>
                    <th style="text-align: center;">Razón</th>
                    <th style="text-align: right;">Duración</th>
                  </tr>
                </thead>
                <tbody id="btTradesTableBody"></tbody>
              </table>
            </div>
          </div>
          
          <div id="backtestError" class="backtest-error">
            <p style="margin: 0; color: #f44336; font-size: var(--font-md);">
              <strong>Error:</strong> <span id="backtestErrorText"></span>
            </p>
          </div>
        </div>
        
        <div id="backtestEmpty" class="backtest-empty">
          <p style="margin: 0; font-size: var(--font-base);">Presiona <strong style="color: var(--color-accent);">"Ejecutar Backtest"</strong> para simular el rendimiento histórico.</p>
        </div>
      </div>
    </div>
    
    <div class="card">
      <h3 class="title">Estado del Trading</h3>
      
      <div id="activeSignalBox" class="active-signal-box" style="display: none;">
        <h3>SEÑAL ACTIVA</h3>
        <div class="active-signal-type" id="activeSignalType">—</div>
        <div class="active-signal-details">
          <div class="detail-item">
            <div class="detail-label">Precio</div>
            <div class="detail-value" id="activePrice">—</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Stop Loss</div>
            <div class="detail-value" id="activeSL">—</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Take Profit</div>
            <div class="detail-value" id="activeTP">—</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">R/R Ratio</div>
            <div class="detail-value" id="activeRR">—</div>
          </div>
        </div>
      </div>

      <h3 class="title" style="margin-top: var(--spacing-lg);">Estadísticas (<span id="signalsCount">0</span> señales)</h3>
      <div class="stats-grid">
        <div class="stat-box">
          <div class="stat-label">LONG (Compra)</div>
          <div class="stat-value signal-long" id="longCount">—</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">SHORT (Venta)</div>
          <div class="stat-value signal-short" id="shortCount">—</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Precio Mín</div>
          <div class="stat-value" id="minPrice">—</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Precio Máx</div>
          <div class="stat-value" id="maxPrice">—</div>
        </div>
      </div>
      
      <div class="period-info" id="periodInfo">
        <strong>Periodo:</strong> <span id="dateRange">—</span>
      </div>
      
      <div style="margin-top: var(--spacing-xl); border-top: 1px solid var(--color-border-light); padding-top: var(--spacing-lg);">
        <h3 class="title">Historial de Señales</h3>
        <div id="signalsContainer" class="signals-container">
          <p class="text-muted" style="text-align: center; padding: var(--spacing-xl) 0;">Cargando señales...</p>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.2.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
  
  <script>
    const TradingApp = {
      config: {
        API_BASE: 'http://127.0.0.1:8000',
        MAX_CHART_BARS: 5000,
        AUTO_REFRESH_INTERVAL: 60000
      },

      state: {
        chart: null,
        signals: [],
        autoRefreshTimer: null,
        countdownTimer: null,
        secondsUntilRefresh: 60
      },

      // Date formatting configuration based on interval and range
      dateFormats: {
        '1mo': {
          5: { format: { year: 'numeric' }, skip: 12 },
          2: { format: { year: 'numeric', month: 'short' }, skip: 6 },
          default: { format: { year: '2-digit', month: 'short' }, skip: 3 }
        },
        '1d': {
          5: { format: { year: 'numeric' }, skip: 365 },
          2: { format: { day: '2-digit', month: 'short', year: '2-digit' }, skip: 90 },
          1: { format: { day: '2-digit', month: 'short', year: '2-digit' }, skip: 30 },
          0.5: { format: { day: '2-digit', month: 'short' }, skip: 14 },
          default: { format: { day: '2-digit', month: 'short' }, skip: 7 }
        },
        '1h': {
          1: { format: { day: '2-digit', month: 'short', year: '2-digit' }, skip: 168 },
          0.25: { format: { day: '2-digit', month: 'short' }, skip: 24 },
          default: { format: { day: '2-digit', hour: '2-digit', minute: '2-digit' }, skip: 12 }
        },
        '15m': {
          0.08: { format: { month: 'short', day: '2-digit' }, skip: 96 },
          default: { format: { day: '2-digit', hour: '2-digit', minute: '2-digit' }, skip: 16 }
        },
        '5m': {
          0.02: { format: { day: '2-digit', hour: '2-digit', minute: '2-digit' }, skip: 24 },
          default: { format: { hour: '2-digit', minute: '2-digit' }, skip: 12 }
        },
        '1m': {
          0.02: { format: { day: '2-digit', hour: '2-digit', minute: '2-digit' }, skip: 60 },
          default: { format: { hour: '2-digit', minute: '2-digit' }, skip: 30 }
        }
      },

      strategyNames: {
        'ema_crossover': 'EMA Crossover',
        'rsi_reversal': 'RSI Reversal',
        'macd_crossover': 'MACD Crossover',
        'bollinger_breakout': 'Bollinger Breakout'
      },

      strategyDescriptions: {
        'ema_crossover': 'Cruces de medias móviles exponenciales con filtros RSI/MACD',
        'rsi_reversal': 'Reversión desde zonas de sobrecompra/sobreventa',
        'macd_crossover': 'Cruces de MACD con confirmación de momentum',
        'bollinger_breakout': 'Ruptura de bandas de Bollinger con tendencia fuerte'
      },

      // API methods
      api: {
        async fetch(url, fallback = null) {
          try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return await response.json();
          } catch (error) {
            console.warn('API fetch error:', url, error);
            return fallback;
          }
        },

        async getSignals(params) {
          const url = `${TradingApp.config.API_BASE}/signals?ticker=${encodeURIComponent(params.ticker)}&years=${params.years}&interval=${params.interval}`;
          return this.fetch(url, []);
        },

        async getExplanations() {
          return this.fetch(`${TradingApp.config.API_BASE}/explanations`, { text: 'Análisis de trading en progreso...' });
        },

        async getBacktestReport() {
          return this.fetch('/backtest_report.json', { metrics: { CAGR: 0.04, Sharpe: 0.16, MaxDrawdown: -0.034 }, last_equity: 10000 });
        },

        async postAnalysis(data) {
          const response = await fetch(`${TradingApp.config.API_BASE}/analysis`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          return response.json();
        },

        async runBacktest(ticker, years, interval) {
          const response = await fetch(
            `${TradingApp.config.API_BASE}/backtest/${encodeURIComponent(ticker)}?years=${years}&interval=${interval}`
          );
          if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          return response.json();
        }
      },

      // UI methods
      ui: {
        getParams() {
          return {
            ticker: document.getElementById('tickerSelect').value,
            years: parseFloat(document.getElementById('rangeSelect').value),
            interval: document.getElementById('intervalSelect').value
          };
        },

        showLoading(show) {
          const overlay = document.getElementById('loadingOverlay');
          overlay.style.display = show ? 'block' : 'none';
        },

        getDateFormat(years, interval) {
          const formats = TradingApp.dateFormats[interval];
          if (!formats) return { format: { month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit' }, skip: 10 };
          
          const thresholds = Object.keys(formats).filter(k => k !== 'default').map(Number).sort((a, b) => b - a);
          for (const threshold of thresholds) {
            if (years >= threshold) return formats[threshold];
          }
          return formats.default;
        },

        getSignalDateFormat(interval, years) {
          if (['1m', '5m', '15m'].includes(interval)) {
            return { weekday: 'short', day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' };
          }
          if (interval === '1h') {
            return years >= 1 
              ? { day: '2-digit', month: 'short', year: 'numeric' }
              : { weekday: 'short', day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' };
          }
          if (interval === '1d') {
            return { weekday: 'short', day: '2-digit', month: 'short', year: 'numeric' };
          }
          return { month: 'long', year: 'numeric' };
        },

        formatSignalLabel(signal) {
          if (signal === 1) return '<span class="signal-long">LONG ▲</span>';
          if (signal === -1) return '<span class="signal-short">SHORT ▼</span>';
          return '<span class="signal-neutral">—</span>';
        },

        updateStats(signals, params) {
          const activeSignals = signals.filter(s => s.signal !== 0);
          const longSignals = activeSignals.filter(s => s.signal === 1);
          const shortSignals = activeSignals.filter(s => s.signal === -1);

          document.getElementById('signalsCount').textContent = activeSignals.length;
          
          if (activeSignals.length > 0) {
            const longPct = ((longSignals.length / activeSignals.length) * 100).toFixed(0);
            const shortPct = ((shortSignals.length / activeSignals.length) * 100).toFixed(0);
            document.getElementById('longCount').textContent = `${longSignals.length} (${longPct}%)`;
            document.getElementById('shortCount').textContent = `${shortSignals.length} (${shortPct}%)`;

            const prices = activeSignals.map(s => s.price);
            document.getElementById('minPrice').textContent = `$${Math.min(...prices).toFixed(2)}`;
            document.getElementById('maxPrice').textContent = `$${Math.max(...prices).toFixed(2)}`;

            const periodFormat = params.interval === '1mo' 
              ? { month: 'short', year: 'numeric' }
              : { day: '2-digit', month: 'short', year: '2-digit' };
            
            const first = new Date(activeSignals[0].timestamp);
            const last = new Date(activeSignals[activeSignals.length - 1].timestamp);
            document.getElementById('dateRange').textContent = 
              `${first.toLocaleDateString('es-ES', periodFormat)} - ${last.toLocaleDateString('es-ES', periodFormat)}`;
          }
        },

        updateActiveSignal(signals, params) {
          const activeSignals = signals.filter(s => s.signal !== 0);
          if (activeSignals.length === 0) return;

          const lastSignal = activeSignals[activeSignals.length - 1];
          const signalBox = document.getElementById('activeSignalBox');
          signalBox.style.display = 'block';

          const signalType = lastSignal.signal === 1 ? 'LONG (Compra)' : 'SHORT (Venta)';
          const signalDate = new Date(lastSignal.timestamp);
          
          let dateFormat;
          if (params.interval === '1mo') {
            dateFormat = { month: 'long', year: 'numeric' };
          } else if (params.interval === '1d') {
            dateFormat = { weekday: 'short', day: '2-digit', month: 'short', year: 'numeric' };
          } else {
            dateFormat = { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' };
          }

          document.getElementById('activeSignalType').textContent = `${signalType} - ${signalDate.toLocaleString('es-ES', dateFormat)}`;
          document.getElementById('activePrice').textContent = `$${lastSignal.price.toFixed(2)}`;
          document.getElementById('activeSL').textContent = lastSignal.sl ? `$${lastSignal.sl.toFixed(2)}` : 'N/A';
          document.getElementById('activeTP').textContent = lastSignal.tp ? `$${lastSignal.tp.toFixed(2)}` : 'N/A';

          if (lastSignal.sl && lastSignal.tp) {
            const risk = Math.abs(lastSignal.price - lastSignal.sl);
            const reward = Math.abs(lastSignal.tp - lastSignal.price);
            document.getElementById('activeRR').textContent = `1:${(reward / risk).toFixed(2)}`;
          } else {
            document.getElementById('activeRR').textContent = 'N/A';
          }
        },

        renderSignalsList(signals, params) {
          const container = document.getElementById('signalsContainer');
          container.innerHTML = '';

          const activeSignals = signals.filter(s => s.signal !== 0);
          
          if (activeSignals.length === 0) {
            container.innerHTML = `
              <div style="text-align: center; padding: 30px;">
                <p class="text-muted">No hay señales activas para <strong>${params.ticker}</strong></p>
                <p class="text-muted text-sm">Prueba con un rango mayor o intervalo diferente</p>
              </div>`;
            return;
          }

          const dateFormat = this.getSignalDateFormat(params.interval, params.years);
          const reversedSignals = [...activeSignals].reverse();

          reversedSignals.forEach((signal, index) => {
            const signalType = signal.signal === 1 ? 'LONG' : 'SHORT';
            const signalClass = signal.signal === 1 ? 'signal-long' : 'signal-short';
            const signalIcon = signal.signal === 1 ? '▲' : '▼';
            const signalAction = signal.signal === 1 ? 'Compra' : 'Venta';
            const hasVotingData = signal.strategy_votes && signal.strategy_votes.length > 0;

            const signalDate = new Date(signal.timestamp);
            const fullDate = signalDate.toLocaleString('es-ES', dateFormat);
            const shortDate = signalDate.toLocaleString('es-ES', {
              day: '2-digit', month: 'short', year: '2-digit', hour: '2-digit', minute: '2-digit'
            });

            const item = document.createElement('div');
            item.className = 'signal-item';
            item.dataset.index = index;
            item.dataset.timestamp = signal.timestamp;

            if (hasVotingData) {
              item.dataset.strategyVotes = JSON.stringify(signal.strategy_votes);
              item.dataset.longVotes = signal.long_votes || 0;
              item.dataset.shortVotes = signal.short_votes || 0;
              item.dataset.neutralVotes = signal.neutral_votes || 0;
              item.dataset.finalSignal = signal.signal;
              item.dataset.price = signal.price;
              item.dataset.score = signal.score;
            }

            const votingBadge = hasVotingData 
              ? `<span class="badge badge--primary" style="margin-left: 8px;">${signal.long_votes || 0}L / ${signal.short_votes || 0}S</span>`
              : '';

            item.innerHTML = `
              <div class="signal-header">
                <span class="signal-type ${signalClass}">${signalIcon} ${signalType} (${signalAction}) ${votingBadge}</span>
                <span class="signal-time">${shortDate}</span>
              </div>
              <div style="font-size: var(--font-sm); color: var(--color-primary); margin-bottom: 4px; font-weight: 500;">${fullDate}</div>
              <div class="signal-price">Precio: $${signal.price.toFixed(2)}</div>
              <div class="signal-details">
                <strong>Confianza:</strong> ${(signal.score * 100).toFixed(0)}% | 
                <strong>SL:</strong> $${signal.sl ? signal.sl.toFixed(2) : 'N/A'} | 
                <strong>TP:</strong> $${signal.tp ? signal.tp.toFixed(2) : 'N/A'}
              </div>
              ${hasVotingData ? '<div class="text-muted text-sm" style="text-align: center; margin-top: 6px;">Clic para ver detalle de votación</div>' : ''}
            `;

            if (hasVotingData) {
              item.addEventListener('click', function(e) {
                TradingApp.ui.showVotingDetail(this);
              });
            }

            container.appendChild(item);
          });
        },

        showVotingDetail(element) {
          const container = document.getElementById('votingDetailContainer');
          const votes = JSON.parse(element.dataset.strategyVotes || '[]');
          const longVotes = parseInt(element.dataset.longVotes) || 0;
          const shortVotes = parseInt(element.dataset.shortVotes) || 0;
          const neutralVotes = parseInt(element.dataset.neutralVotes) || 0;
          const finalSignal = parseInt(element.dataset.finalSignal);
          const price = parseFloat(element.dataset.price);
          const score = parseFloat(element.dataset.score);
          const timestamp = element.dataset.timestamp;

          const signalDate = new Date(timestamp);
          const dateStr = signalDate.toLocaleString('es-ES', {
            weekday: 'short', day: '2-digit', month: 'short', year: 'numeric',
            hour: '2-digit', minute: '2-digit'
          });

          document.getElementById('votingTitle').innerHTML = 
            `Detalle de Votación - <span style="color: var(--color-primary);">${dateStr}</span> - Precio: $${price.toFixed(2)}`;

          const finalText = finalSignal === 1 ? 'LONG' : finalSignal === -1 ? 'SHORT' : 'NEUTRAL';
          const finalColor = finalSignal === 1 ? 'var(--color-success)' : finalSignal === -1 ? 'var(--color-danger)' : 'var(--color-neutral)';
          
          document.getElementById('votingFinalSignal').innerHTML = `<span style="color: ${finalColor}">${finalText}</span>`;
          document.getElementById('votingLongCount').textContent = longVotes;
          document.getElementById('votingShortCount').textContent = shortVotes;
          document.getElementById('votingNeutralCount').textContent = neutralVotes;

          const grid = document.getElementById('strategyVotesGrid');
          grid.innerHTML = '';

          votes.forEach(vote => {
            const voteColor = vote.vote === 'LONG' ? 'var(--color-success)' : vote.vote === 'SHORT' ? 'var(--color-danger)' : 'var(--color-neutral)';
            const voteBg = vote.vote === 'LONG' ? 'var(--color-success-light)' : vote.vote === 'SHORT' ? 'var(--color-danger-light)' : '#f5f5f5';
            const voteBorder = vote.vote === 'LONG' ? '#a5d6a7' : vote.vote === 'SHORT' ? '#ef9a9a' : 'var(--color-border)';
            const scorePercent = (vote.score * 100).toFixed(0);

            const card = document.createElement('div');
            card.className = 'strategy-card';
            card.style.background = voteBg;
            card.style.borderColor = voteBorder;
            card.innerHTML = `
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                <span style="font-weight: 600; font-size: var(--font-base); color: var(--color-text);">${TradingApp.strategyNames[vote.name] || vote.name}</span>
              </div>
              <div style="font-size: var(--font-xl); font-weight: bold; color: ${voteColor}; margin-bottom: 4px;">${vote.vote}</div>
              <div style="font-size: var(--font-sm); color: var(--color-text-muted);">Score: <strong>${scorePercent}%</strong></div>
              <div style="font-size: var(--font-xs); color: #888; line-height: 1.3;">${TradingApp.strategyDescriptions[vote.name] || 'Estrategia de trading algorítmico'}</div>
            `;
            grid.appendChild(card);
          });

          const totalVotes = longVotes + shortVotes + neutralVotes;
          const majority = Math.ceil(totalVotes / 2) + (totalVotes % 2 === 0 ? 1 : 0);
          const winningVotes = finalSignal === 1 ? longVotes : finalSignal === -1 ? shortVotes : 0;

          document.getElementById('votingInfo').innerHTML = `
            <strong>Metodología:</strong> La señal final se determina por <em>votación mayoritaria</em>. 
            Se requiere al menos <strong>${majority}/${totalVotes}</strong> votos para generar una señal.
            ${finalSignal !== 0 ? `<br><strong>Resultado:</strong> ${winningVotes} de ${totalVotes} estrategias votaron ${finalSignal === 1 ? 'LONG' : 'SHORT'} (${((winningVotes/totalVotes)*100).toFixed(0)}% consenso).` : ''}
            <br><strong>Score final:</strong> ${(score * 100).toFixed(0)}% (promedio de estrategias coincidentes).
          `;

          container.style.display = 'block';
          container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        },

        hideVotingDetail() {
          document.getElementById('votingDetailContainer').style.display = 'none';
        },

        toggleAccordion(type) {
          const isAnalysis = type === 'analysis';
          const content = document.getElementById(isAnalysis ? 'analysisAccordionContent' : 'backtestTradesContent');
          const icon = document.getElementById(isAnalysis ? 'accordionIcon' : 'btAccordionIcon');

          if (content.style.display === 'none') {
            content.style.display = 'block';
            icon.style.transform = 'rotate(180deg)';
          } else {
            content.style.display = 'none';
            icon.style.transform = 'rotate(0deg)';
          }
        },

        resetSections() {
          // Reset analysis
          document.getElementById('analysisContent').style.display = 'none';
          document.getElementById('analysisEmpty').style.display = 'block';
          document.getElementById('analysisEmpty').innerHTML = '<p style="margin: 0; font-size: var(--font-base);">Presiona <strong style="color: #e94560;">"Generar Análisis"</strong> para obtener una explicación detallada.</p>';
          document.getElementById('analysisAccordionContent').style.display = 'none';
          document.getElementById('accordionIcon').style.transform = 'rotate(0deg)';

          // Reset backtest
          document.getElementById('backtestContent').style.display = 'none';
          document.getElementById('backtestEmpty').style.display = 'block';
          document.getElementById('backtestEmpty').innerHTML = '<p style="margin: 0; font-size: var(--font-base);">Presiona <strong style="color: var(--color-accent);">"Ejecutar Backtest"</strong> para simular el rendimiento histórico.</p>';
          document.getElementById('backtestTradesContent').style.display = 'none';
          document.getElementById('btAccordionIcon').style.transform = 'rotate(0deg)';
        }
      },

      // Chart methods
      chart: {
        // Calcula el número máximo de barras según el rango e intervalo
        getMaxBarsForRange(years, interval) {
          // Barras estimadas por intervalo y año
          const barsPerYear = {
            '1m': 252 * 6.5 * 60,   // ~98,280 barras/año (días trading × horas × minutos)
            '5m': 252 * 6.5 * 12,   // ~19,656 barras/año
            '15m': 252 * 6.5 * 4,   // ~6,552 barras/año
            '1h': 252 * 8,           // ~2,016 barras/año (Forex es ~24h)
            '1d': 252,               // ~252 barras/año
            '1mo': 12                // 12 barras/año
          };
          
          const estimatedBars = (barsPerYear[interval] || 2000) * years;
          // Limitar a 10000 máximo por rendimiento, pero mostrar todos si son menos
          return Math.min(Math.ceil(estimatedBars * 1.2), 10000);
        },

        // Muestrea datos si hay demasiados puntos para mantener rendimiento
        sampleData(signals, maxBars) {
          if (signals.length <= maxBars) return signals;
          
          // Muestreo uniforme manteniendo primera/última barra y todas las señales activas
          const step = signals.length / maxBars;
          const sampled = [];
          const signalIndices = new Set();
          
          // Siempre incluir barras con señales activas
          signals.forEach((s, i) => {
            if (s.signal !== 0) signalIndices.add(i);
          });
          
          // Muestreo uniforme
          for (let i = 0; i < signals.length; i += step) {
            const idx = Math.floor(i);
            if (!signalIndices.has(idx)) {
              sampled.push({ ...signals[idx], _idx: idx });
            }
          }
          
          // Agregar todas las barras con señales
          signalIndices.forEach(idx => {
            sampled.push({ ...signals[idx], _idx: idx });
          });
          
          // Ordenar por índice original y retornar
          return sampled.sort((a, b) => a._idx - b._idx);
        },

        create(signals, params) {
          const ctx = document.getElementById('priceChart').getContext('2d');
          
          if (TradingApp.state.chart) {
            TradingApp.state.chart.destroy();
            TradingApp.state.chart = null;
          }

          const maxBars = this.getMaxBarsForRange(params.years, params.interval);
          const chartData = this.sampleData(signals, maxBars);

          const candlestickData = chartData.map((s, i) => ({
            x: i,
            o: s.open,
            h: s.high,
            l: s.low,
            c: s.close,
            signal: s.signal,
            timestamp: s.timestamp
          }));

          const longSignals = chartData.map((s, i) => ({
            x: i,
            y: s.signal === 1 ? s.price : null,
            timestamp: s.timestamp
          })).filter(p => p.y !== null);

          const shortSignals = chartData.map((s, i) => ({
            x: i,
            y: s.signal === -1 ? s.price : null,
            timestamp: s.timestamp
          })).filter(p => p.y !== null);

          const dateFormatConfig = TradingApp.ui.getDateFormat(params.years, params.interval);

          TradingApp.state.chart = new Chart(ctx, {
            type: 'candlestick',
            data: {
              datasets: [
                {
                  label: 'Precio',
                  data: candlestickData,
                  borderColor: '#333',
                  backgroundColors: {
                    up: '#26a69a',
                    down: '#ef5350',
                    unchanged: '#999'
                  }
                },
                {
                  label: 'LONG ▲',
                  type: 'scatter',
                  data: longSignals,
                  backgroundColor: '#4CAF50',
                  borderColor: '#2E7D32',
                  borderWidth: 2,
                  pointRadius: 8,
                  pointStyle: 'triangle',
                  rotation: 0
                },
                {
                  label: 'SHORT ▼',
                  type: 'scatter',
                  data: shortSignals,
                  backgroundColor: '#F44336',
                  borderColor: '#C62828',
                  borderWidth: 2,
                  pointRadius: 8,
                  pointStyle: 'triangle',
                  rotation: 180
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: true, position: 'top' },
                tooltip: {
                  mode: 'index',
                  intersect: false,
                  backgroundColor: 'rgba(0, 0, 0, 0.85)',
                  titleColor: '#fff',
                  bodyColor: '#fff',
                  borderColor: 'var(--color-primary)',
                  borderWidth: 1,
                  padding: 12,
                  displayColors: true,
                  callbacks: {
                    title: (context) => {
                      const index = context[0].parsed.x;
                      if (chartData[index]) {
                        const date = new Date(chartData[index].timestamp);
                        return date.toLocaleString('es-ES', {
                          weekday: 'short', day: '2-digit', month: 'short',
                          year: 'numeric', hour: '2-digit', minute: '2-digit'
                        });
                      }
                      return '';
                    },
                    label: (context) => {
                      const label = context.dataset.label || '';
                      const index = context.parsed.x;
                      
                      if (label === 'Precio' && chartData[index]) {
                        const candle = chartData[index];
                        return [
                          `Apertura: $${candle.open.toFixed(2)}`,
                          `Máximo: $${candle.high.toFixed(2)}`,
                          `Mínimo: $${candle.low.toFixed(2)}`,
                          `Cierre: $${candle.close.toFixed(2)}`
                        ];
                      }
                      
                      if (context.parsed.y !== undefined && context.parsed.y !== null) {
                        return `${label}: $${context.parsed.y.toFixed(2)}`;
                      }
                      return null;
                    },
                    labelColor: (context) => {
                      const colors = {
                        'LONG ▲': { borderColor: '#4CAF50', backgroundColor: '#4CAF50' },
                        'SHORT ▼': { borderColor: '#F44336', backgroundColor: '#F44336' }
                      };
                      return colors[context.dataset.label] || { borderColor: 'var(--color-primary)', backgroundColor: 'var(--color-primary)' };
                    }
                  }
                },
                zoom: {
                  zoom: {
                    wheel: { enabled: true, speed: 0.1 },
                    pinch: { enabled: true },
                    drag: {
                      enabled: true,
                      backgroundColor: 'rgba(33, 150, 243, 0.1)',
                      borderColor: 'rgba(33, 150, 243, 0.5)',
                      borderWidth: 1
                    },
                    mode: 'xy'
                  },
                  pan: { enabled: true, mode: 'xy' },
                  limits: {
                    x: { min: 'original', max: 'original' },
                    y: { min: 'original', max: 'original' }
                  }
                }
              },
              scales: {
                x: {
                  type: 'linear',
                  min: 0,
                  max: chartData.length - 1,
                  ticks: {
                    maxRotation: 45,
                    minRotation: 0,
                    autoSkip: true,
                    autoSkipPadding: 15,
                    maxTicksLimit: 12,
                    callback: (value, index) => {
                      if (!Number.isInteger(value) || value < 0 || value >= chartData.length) return '';
                      const dynamicSkip = Math.max(1, Math.floor(chartData.length / 10));
                      if (value % dynamicSkip !== 0 && value !== chartData.length - 1) return '';
                      if (chartData[value]) {
                        const date = new Date(chartData[value].timestamp);
                        return date.toLocaleString('es-ES', dateFormatConfig.format);
                      }
                      return '';
                    },
                    font: { size: 10 }
                  },
                  grid: { display: true, color: 'rgba(0, 0, 0, 0.05)' }
                },
                y: {
                  display: true,
                  position: 'right',
                  ticks: { callback: (value) => value.toFixed(2) }
                }
              },
              interaction: { mode: 'nearest', axis: 'x', intersect: false }
            }
          });
        },

        reset() {
          if (TradingApp.state.chart) {
            TradingApp.state.chart.resetZoom();
          }
        }
      },

      // Analysis methods
      analysis: {
        async generate() {
          const btn = document.getElementById('generateAnalysisBtn');
          const btnIcon = document.getElementById('analysisButtonIcon');
          const btnText = document.getElementById('analysisButtonText');
          const loading = document.getElementById('analysisLoadingIndicator');
          const content = document.getElementById('analysisContent');
          const empty = document.getElementById('analysisEmpty');
          const error = document.getElementById('analysisError');

          const params = TradingApp.ui.getParams();
          const activeSignals = TradingApp.state.signals.filter(s => s.signal !== 0);

          if (activeSignals.length === 0) {
            alert('No hay señales activas para analizar.');
            return;
          }

          btn.disabled = true;
          btnIcon.textContent = '...';
          btnText.textContent = 'Analizando...';
          loading.style.display = 'block';
          content.style.display = 'none';
          empty.style.display = 'none';
          error.style.display = 'none';

          try {
            const result = await TradingApp.api.postAnalysis({
              ticker: params.ticker,
              signals: TradingApp.state.signals,
              use_cache: true
            });

            document.getElementById('analysisSignalCount').textContent = result.signal_count;
            document.getElementById('analysisCacheStatus').innerHTML = result.cached 
              ? '<span style="color: #81c784;">Desde caché</span>'
              : '<span style="color: #4fc3f7;">Nuevo</span>';

            document.getElementById('analysisText').innerHTML = this.formatText(result.analysis);

            if (result.error) {
              document.getElementById('analysisErrorText').textContent = result.error;
              error.style.display = 'block';
            }

            loading.style.display = 'none';
            content.style.display = 'block';
            document.getElementById('analysisAccordionContent').style.display = 'block';
            document.getElementById('accordionIcon').style.transform = 'rotate(180deg)';

          } catch (err) {
            console.error('Analysis error:', err);
            loading.style.display = 'none';
            empty.style.display = 'block';
            empty.innerHTML = `<p style="margin: 0; color: #f44336;"><strong>Error:</strong> ${err.message}</p>`;
          } finally {
            btn.disabled = false;
            btnIcon.textContent = '+';
            btnText.textContent = 'Generar Análisis';
          }
        },

        formatText(text) {
          return text
            .replace(/^### (.*$)/gim, '<h3>$1</h3>')
            .replace(/^## (.*$)/gim, '<h2>$1</h2>')
            .replace(/^# (.*$)/gim, '<h1>$1</h1>')
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/`(.*?)`/g, '<code>$1</code>')
            .replace(/\n/g, '<br>')
            .replace(/<analisis>/g, '<div style="background: rgba(79, 195, 247, 0.1); border-left: 3px solid #4fc3f7; padding: 12px; margin: 12px 0; border-radius: 0 8px 8px 0;"><strong style="color: #4fc3f7;">Análisis:</strong><br>')
            .replace(/<\/analisis>/g, '</div>')
            .replace(/<explicacion_señal>/g, '<div style="background: rgba(233, 69, 96, 0.1); border-left: 3px solid #e94560; padding: 12px; margin: 12px 0; border-radius: 0 8px 8px 0;"><strong style="color: #e94560;">Explicación:</strong><br>')
            .replace(/<\/explicacion_señal>/g, '</div>')
            .replace(/LONG/g, '<span style="color: #81c784; font-weight: bold;">LONG</span>')
            .replace(/SHORT/g, '<span style="color: #ef5350; font-weight: bold;">SHORT</span>');
        }
      },

      // Backtest methods
      backtest: {
        async run() {
          const btn = document.getElementById('runBacktestBtn');
          const btnIcon = document.getElementById('backtestButtonIcon');
          const btnText = document.getElementById('backtestButtonText');
          const loading = document.getElementById('backtestLoadingIndicator');
          const content = document.getElementById('backtestContent');
          const empty = document.getElementById('backtestEmpty');
          const error = document.getElementById('backtestError');

          const params = TradingApp.ui.getParams();

          btn.disabled = true;
          btnIcon.textContent = '...';
          btnText.textContent = 'Ejecutando...';
          loading.style.display = 'block';
          content.style.display = 'none';
          empty.style.display = 'none';
          error.style.display = 'none';

          try {
            const result = await TradingApp.api.runBacktest(params.ticker, params.years, params.interval);

            if (result.error) throw new Error(result.error);

            this.updateKPIs(result.summary);
            this.renderTrades(result.trades);

            document.getElementById('btTradeCount').textContent = result.trades.length;

            loading.style.display = 'none';
            content.style.display = 'block';

          } catch (err) {
            console.error('Backtest error:', err);
            document.getElementById('backtestErrorText').textContent = err.message;
            error.style.display = 'block';
            loading.style.display = 'none';
            empty.style.display = 'block';
            empty.innerHTML = `<p style="margin: 0; color: #f44336;"><strong>Error:</strong> ${err.message}</p>`;
          } finally {
            btn.disabled = false;
            btnIcon.textContent = '▶';
            btnText.textContent = 'Ejecutar Backtest';
          }
        },

        updateKPIs(summary) {
          document.getElementById('btTotalTrades').textContent = summary.total_trades;
          document.getElementById('btWinRate').textContent = `${summary.win_rate.toFixed(1)}%`;

          const pnlBox = document.getElementById('btPnlBox');
          const pnlEl = document.getElementById('btTotalPnl');
          const pnl = summary.total_pnl;

          if (pnl >= 0) {
            pnlBox.className = 'kpi-box kpi-box--success';
            pnlEl.className = 'kpi-value kpi-value--success';
            pnlEl.textContent = `+$${pnl.toFixed(2)}`;
          } else {
            pnlBox.className = 'kpi-box kpi-box--danger';
            pnlEl.className = 'kpi-value kpi-value--danger';
            pnlEl.textContent = `-$${Math.abs(pnl).toFixed(2)}`;
          }

          document.getElementById('btMaxDD').textContent = `${summary.max_drawdown_pct.toFixed(1)}%`;
          document.getElementById('btSharpe').textContent = summary.sharpe_ratio.toFixed(2);
          document.getElementById('btProfitFactor').textContent = summary.profit_factor >= 999 ? '∞' : summary.profit_factor.toFixed(2);
          document.getElementById('btBestTrade').textContent = `+$${summary.best_trade.toFixed(2)}`;
          document.getElementById('btWorstTrade').textContent = `$${summary.worst_trade.toFixed(2)}`;
          document.getElementById('btInitialCapital').textContent = `$${summary.initial_capital.toLocaleString()}`;
          document.getElementById('btFinalEquity').textContent = `$${summary.final_equity.toLocaleString()}`;
        },

        renderTrades(trades) {
          const tbody = document.getElementById('btTradesTableBody');
          tbody.innerHTML = '';

          trades.forEach(trade => {
            const isLong = trade.side === 'LONG';
            const isProfitable = trade.pnl > 0;
            const isOpen = trade.status === 'OPEN';

            let durationStr = '—';
            if (trade.duration_minutes !== null) {
              const mins = trade.duration_minutes;
              if (mins < 60) durationStr = `${mins}m`;
              else if (mins < 1440) durationStr = `${Math.floor(mins / 60)}h ${mins % 60}m`;
              else durationStr = `${Math.floor(mins / 1440)}d ${Math.floor((mins % 1440) / 60)}h`;
            }

            let entryDateStr = '—';
            try {
              const entryDate = new Date(trade.entry_time);
              entryDateStr = entryDate.toLocaleDateString('es', { day: '2-digit', month: 'short', year: '2-digit' }) +
                           ' ' + entryDate.toLocaleTimeString('es', { hour: '2-digit', minute: '2-digit' });
            } catch {}

            const row = document.createElement('tr');
            row.innerHTML = `
              <td style="color: #e0e1dd;">${trade.id}</td>
              <td style="color: #778da9; font-size: var(--font-sm); white-space: nowrap;">${entryDateStr}</td>
              <td><span class="trade-side ${isLong ? 'trade-side--long' : 'trade-side--short'}">${trade.side}</span></td>
              <td style="text-align: right; color: #e0e1dd; font-family: monospace;">$${trade.entry_price.toFixed(2)}</td>
              <td style="text-align: right; color: #e0e1dd; font-family: monospace;">
                ${isOpen ? '<span style="color: #fbbf24;">ABIERTO</span>' : '$' + trade.exit_price.toFixed(2)}
              </td>
              <td style="text-align: right; font-weight: bold; font-family: monospace; color: ${isProfitable ? '#10b981' : '#ef4444'};">
                ${isOpen ? '—' : (isProfitable ? '+' : '') + '$' + trade.pnl.toFixed(2)}
              </td>
              <td style="text-align: center;">
                ${isOpen ? '—' : `<span class="badge ${trade.exit_reason === 'TP' ? 'badge--success' : 'badge--danger'}">${trade.exit_reason}</span>`}
              </td>
              <td style="text-align: right; color: #778da9; font-size: var(--font-sm);">${durationStr}</td>
            `;
            tbody.appendChild(row);
          });
        }
      },

      // Auto-refresh methods
      autoRefresh: {
        start() {
          TradingApp.state.secondsUntilRefresh = 60;
          this.updateIndicator();

          TradingApp.state.countdownTimer = setInterval(() => {
            TradingApp.state.secondsUntilRefresh--;
            this.updateIndicator();
          }, 1000);

          TradingApp.state.autoRefreshTimer = setInterval(() => {
            TradingApp.state.secondsUntilRefresh = 60;
            TradingApp.init();
          }, TradingApp.config.AUTO_REFRESH_INTERVAL);
        },

        updateIndicator() {
          document.getElementById('refresh-indicator').textContent = 
            `Auto-refresh: ${TradingApp.state.secondsUntilRefresh}s`;
        }
      },

      // Main initialization
      async init() {
        const params = this.ui.getParams();
        
        document.getElementById('currentTicker').textContent = params.ticker;
        this.ui.showLoading(true);

        const signals = await this.api.getSignals(params);
        this.state.signals = signals;

        this.ui.showLoading(false);

        if (signals.length === 0) {
          document.getElementById('signalsContainer').innerHTML = `
            <div style="text-align: center; padding: 30px;">
              <p class="text-muted">No hay datos disponibles para <strong>${params.ticker}</strong></p>
              <p class="text-muted text-sm">Prueba con un rango mayor o intervalo diferente</p>
            </div>`;
          return;
        }

        const activeSignals = signals.filter(s => s.signal !== 0);

        this.ui.updateStats(signals, params);
        this.ui.updateActiveSignal(signals, params);
        this.ui.renderSignalsList(signals, params);
        this.chart.create(signals, params);
      },

      // Límites de datos de Yahoo Finance por intervalo (en años)
      dataLimits: {
        '1m': { maxYears: 0.02, maxDays: 7, label: '7 días' },
        '5m': { maxYears: 0.17, maxDays: 60, label: '60 días' },
        '15m': { maxYears: 0.17, maxDays: 60, label: '60 días' },
        '1h': { maxYears: 2, maxDays: 730, label: '2 años' },
        '1d': { maxYears: 10, maxDays: 3650, label: '10 años' },
        '1mo': { maxYears: 20, maxDays: 7300, label: '20 años' }
      },

      // Muestra advertencia de límite de datos
      showDataLimitWarning() {
        const interval = document.getElementById('intervalSelect').value;
        const years = parseFloat(document.getElementById('rangeSelect').value);
        const limit = this.dataLimits[interval];
        const infoEl = document.getElementById('currentLimitInfo');
        
        if (years > limit.maxYears) {
          const rangeLabel = document.getElementById('rangeSelect').selectedOptions[0].text;
          infoEl.innerHTML = `⚠️ <strong>Atención:</strong> Para intervalo ${interval}, Yahoo Finance limita a <strong>${limit.label}</strong> de datos. Seleccionaste "${rangeLabel}" pero solo se mostrarán los últimos ${limit.label}.`;
          infoEl.style.display = 'block';
        } else {
          infoEl.style.display = 'none';
        }
      },

      // Setup event listeners
      setup() {
        document.getElementById('loadDataBtn').addEventListener('click', () => {
          this.ui.resetSections();
          this.init();
        });

        document.getElementById('resetZoom').addEventListener('click', () => this.chart.reset());

        // Validar límites al cambiar intervalo
        document.getElementById('intervalSelect').addEventListener('change', () => {
          this.showDataLimitWarning();
        });

        // Validar límites al cambiar rango
        document.getElementById('rangeSelect').addEventListener('change', () => {
          this.showDataLimitWarning();
        });

        // Mostrar advertencia inicial si aplica
        this.showDataLimitWarning();

        // Initialize
        this.init();
        this.autoRefresh.start();
      }
    };

    // Start application
    TradingApp.setup();
  </script>
</body>
</html>